<!DOCTYPE html>
<html lang="pt-pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evereste Academy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js para gráficos do dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      /* Cores do Logo LIDS */
      --brand-blue: #0066cc;
      --brand-orange: #ff6b35;
      --brand-teal: #00a896;
      --brand-purple: #6a4c93;
      --brand-yellow: #ffc857;

      /* Paleta Principal */
      --primary: #0066cc;
      --primary-dark: #004c99;
      --primary-light: #3385d6;
      --accent: #ff6b35;
      --accent-light: #ff8c61;

      /* Tema Claro */
      --surface: #ffff;
      --surface-light: #f8fafc;
      --surface-card: #ffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: rgba(0, 102, 204, 0.12);
      --glow: rgba(0, 102, 204, 0.2);

      /* Hero (Tema Escuro) */
      --hero-bg: #0f172a;
      --hero-text: #ffff;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 50%, #fef3c7 100%);
      color: var(--text);
      position: relative;
      overflow-x: hidden; /* Previne scroll horizontal */
    }

    /* Scroll Progress Bar */
    #scroll-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
      z-index: 100;
      transition: width 100ms ease;
    }

    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }

    /* Header Glassmorphism */
    .header-glass {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: saturate(180%) blur(16px);
      background: rgba(255, 255, 255, 0.85);
      border-bottom: 1px solid var(--border);
      transition: all 300ms ease;
      box-shadow: 0 4px 12px rgba(0, 102, 204, 0.08);
    }

    .header-scrolled {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 10px 30px rgba(0, 102, 204, 0.15);
      border-color: rgba(0, 102, 204, 0.2);
    }

    /* Hero (Tema Escuro) */
    .hero {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
      background-size: 200% 200%;
      animation: gradientShift 8s ease infinite;
    }

    @keyframes gradientShift {
      0%,
      100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(1200px 500px at 80% -10%, rgba(0, 102, 204, 0.2), transparent 50%),
        radial-gradient(900px 380px at 10% 10%, rgba(255, 107, 53, 0.15), transparent 60%);
      pointer-events: none;
    }

    .scroll-indicator {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      animation: bounce 2s infinite;
      color: var(--hero-text);
    }

    @keyframes bounce {
      0%,
      100% {
        transform: translateX(-50%) translateY(0);
      }
      50% {
        transform: translateX(-50%) translateY(-10px);
      }
    }

    /* Particles */
    .particles {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .particles span {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 999px;
      animation: float 12s linear infinite;
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
    }

    @keyframes float {
      0% {
        transform: translateY(0) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-120vh) translateX(20vw);
        opacity: 0;
      }
    }

    /* 3D Cards with Gradient Border */
    .card-3d {
      background: var(--surface-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 102, 204, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card-3d::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      padding: 2px;
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 300ms ease;
    }

    .card-3d:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 50px rgba(0, 102, 204, 0.2), 0 0 0 1px var(--glow);
    }

    .card-3d:hover::before {
      opacity: 1;
    }

    /* Solid Color Course Cards */
    .course-card-solid {
      border: none;
      color: white;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .course-card-solid::before {
      display: none;
    }

    .course-card-solid:hover {
      transform: translateY(-8px) scale(1.02);
      filter: brightness(1.1);
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal));
      border: 1px solid rgba(0, 102, 204, 0.3);
      border-radius: 12px;
      color: #fff;
      padding: 12px 24px;
      font-weight: 700;
      transition: all 250ms ease;
      box-shadow: 0 8px 24px rgba(0, 102, 204, 0.25);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
      transition: transform 400ms ease;
    }

    .btn-primary:hover::before {
      transform: translateX(100%);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 102, 204, 0.35);
    }

    .btn-ghost {
      background: rgba(0, 102, 204, 0.08);
      border: 1px solid var(--border);
      color: var(--primary);
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 700;
      transition: all 250ms ease;
    }

    .btn-ghost:hover {
      transform: translateY(-2px);
      background: rgba(0, 102, 204, 0.15);
      border-color: var(--primary);
    }
    
    .btn-disabled {
      background: #94a3b8;
      color: #e2e8f0;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .btn-disabled:hover {
      background: #94a3b8;
      box-shadow: none;
      transform: none;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-danger:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      transition: all 200ms ease;
    }
    .btn-edit:hover {
      background: #2563eb;
      transform: translateY(-1px);
    }


    /* Reveal Animation */
    .reveal {
      opacity: 0;
      transform: translateY(30px);
      transition: all 600ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .reveal.show {
      opacity: 1;
      transform: translateY(0);
    }

    .stagger-1 {
      transition-delay: 100ms;
    }

    .stagger-2 {
      transition-delay: 200ms;
    }

    .stagger-3 {
      transition-delay: 300ms;
    }

    .stagger-4 {
      transition-delay: 400ms;
    }

    .stagger-5 {
      transition-delay: 500ms;
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(0, 102, 204, 0.12);
      border: 1px solid rgba(0, 102, 204, 0.25);
      color: var(--primary);
      font-size: 14px;
    }

    .badge-soon {
      background: rgba(255, 200, 87, 0.15);
      border-color: rgba(255, 200, 87, 0.4);
      color: #d97706;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(8px);
      opacity: 0;
      visibility: hidden;
      transition: all 250ms ease;
      z-index: 70;
      display: flex; /* Alterado para flex */
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal-backdrop.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-card {
      width: 100%;
      border-radius: 20px;
      background: var(--surface-card);
      border: 1px solid var(--border);
      transform: translateY(20px) scale(0.95);
      opacity: 0;
      transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 25px 70px rgba(0, 102, 204, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.5);
      max-height: 90vh; /* Altura máxima */
      overflow-y: auto; /* Scroll se necessário */
    }
    
    .modal-card-sm { max-width: 520px; }
    .modal-card-md { max-width: 640px; } /* Novo tamanho */
    .modal-card-lg { max-width: 800px; }
    .modal-card-xl { max-width: 1024px; }


    .modal-backdrop.show .modal-card {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    /* Gradient Text */
    .gradient-text {
      background: linear-gradient(135deg, var(--brand-blue), var(--brand-teal), var(--brand-orange));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    /* Blur Blob Decoration */
    .blur-blob {
      position: absolute;
      width: 400px;
      height: 400px;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.15;
      pointer-events: none;
      z-index: -1;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-light);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--brand-blue), var(--brand-teal));
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
    
    /* Scrollbar para Modais */
    .modal-card::-webkit-scrollbar-thumb {
      background: var(--brand-purple);
    }

    /* Instructor Avatar */
    .instructor-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      transition: all 250ms ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .instructor-avatar:hover {
      transform: scale(1.1);
    }

    /* Section Backgrounds */
    .section-light {
      background: var(--surface);
    }

    .section-alt {
      background: linear-gradient(135deg, rgba(0, 102, 204, 0.03), rgba(0, 168, 150, 0.03));
    }

    /* Course Detail Page Styles */
    .course-detail-hero {
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }

    .course-detail-content {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Admin Panel Styles */
    #admin-panel {
      min-height: 100vh;
      display: flex;
    }
    #admin-nav {
      width: 260px;
      background: #0f172a; /* Dark blue */
      color: #e2e8f0;
    }
    #admin-content {
      flex: 1;
      background: #f1f5f9; /* Light gray */
    }
    .admin-nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      color: #94a3b8;
      font-weight: 600;
      transition: all 200ms ease;
      border-left: 4px solid transparent;
    }
    .admin-nav-link:hover {
      color: #f1f5f9;
      background: #1e293b;
    }
    .admin-nav-link.active {
      color: #fff;
      background: linear-gradient(90deg, rgba(0,102,204,0.3), transparent);
      border-left-color: var(--brand-blue);
    }
    .admin-nav-link .fa-solid {
      width: 20px;
      text-align: center;
    }
    
    /* Admin Table Styles */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    .admin-table th, .admin-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    .admin-table th {
      background: #f8fafc;
      color: #64748b;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 700;
    }
    .admin-table td {
      color: #334155;
      font-size: 14px;
    }
    .admin-table tbody tr:last-child td {
      border-bottom: none;
    }
    .admin-table tbody tr:hover {
      background: #f1f5f9;
    }
    .admin-table .actions {
      display: flex;
      gap: 10px;
    }
    
    /* Admin Form Fields */
    .admin-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-muted);
    }
    .admin-input, .admin-textarea, .admin-select {
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text);
      background: var(--surface-light);
      transition: all 200ms ease;
    }
    .admin-input:focus, .admin-textarea:focus, .admin-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.2);
    }
    .admin-textarea {
      min-height: 120px;
      font-family: monospace;
    }
    
    /* Checkbox list */
    .checkbox-list {
      max-height: 150px;
      overflow-y: auto;
      background: var(--surface-light);
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
    }
    .checkbox-list label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
    }
    .checkbox-list label:hover {
      background: #e2e8f0;
    }
    .checkbox-list input {
      width: 16px;
      height: 16px;
      accent-color: var(--primary);
    }

    /* Toasts (Notificações) */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }
    .toast {
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      border: 1px solid rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(120%);
      opacity: 0;
      transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 300px;
    }
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    .toast-success {
      background: #dcfce7;
      color: #166534;
      border-left: 5px solid #22c55e;
    }
    .toast-error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 5px solid #ef4444;
    }
    .toast .icon {
      font-size: 20px;
    }
    .toast-message {
      font-weight: 600;
      flex: 1;
    }
    .toast-close {
      background: transparent;
      border: none;
      color: inherit;
      opacity: 0.6;
      cursor: pointer;
      font-size: 18px;
    }
    .toast-close:hover {
      opacity: 1;
    }

    /* Consent Checkbox Styling */
    .consent-label {
      display: flex;
      align-items: flex-start; /* Alinha no topo se o texto quebrar */
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
    }
    .consent-label input {
       margin-top: 2px; /* Alinha melhor com a primeira linha do texto */
       flex-shrink: 0; /* Não encolhe o checkbox */
    }
    .consent-label a {
      color: var(--primary);
      text-decoration: underline;
    }

  </style>
</head>

<body class="antialiased">
  <!-- Container de Notificações Toast -->
  <div id="toast-container"></div>
  
  <!-- Scroll Progress Bar -->
  <div id="scroll-progress"></div>

  <!-- Header -->
  <header id="header" class="header-glass">
    <div class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <a href="#" id="logo-link" class="cursor-pointer">
          <img src="https://i.postimg.cc/hvvWCwnk/Prancheta-1-1.png" alt="Logo LIDS" class="h-10 w-auto" />
        </a>
      </div>
      <div class="flex items-center gap-4">
        <!-- Botão Admin visível apenas se logado como admin -->
        <button id="adminBtnHeader" class="btn-ghost text-sm"><i class="fas fa-lock mr-2"></i>Admin</button>
        <!-- Botão Logout visível apenas se logado como admin -->
        <button id="logoutBtnHeader" class="btn-danger text-sm hidden"><i class="fas fa-right-from-bracket mr-2"></i>Logout</button>
      </div>
    </div>
  </header>

  <!-- Main View (Course List) -->
  <div id="main-view">
    <!-- Hero (Tema Escuro) -->
    <section class="hero relative text-white">
      <div class="relative z-10 container mx-auto px-6 py-24 md:py-32">
        <div class="reveal max-w-3xl">
          <span class="badge mb-5" style="background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-bolt"></i> Inscrições Abertas</span>
          <!-- Título Alterado: Removido "Capacitações" -->
          <h1 class="text-5xl md:text-7xl font-black leading-tight mb-4" style="color: white;">Evereste Academy</h1>
          <p class="text-lg md:text-xl text-slate-200 max-w-2xl mb-8">Formações práticas e focadas em resultados para elevar a excelência do Instituto Evereste. Profissionalismo, dinamismo e tecnologia a favor do seu desenvolvimento.</p>
          <div class="flex items-center gap-4 flex-wrap">
            <a href="#cursos" class="btn-primary"><i class="fa-solid fa-graduation-cap mr-2"></i> Ver Cursos</a>
          </div>
        </div>
      </div>
      <div class="scroll-indicator text-white text-2xl">
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="particles" id="particles"></div>
      <img src="https://i.postimg.cc/4xNpxRZJ/capabannerlids.png" alt="Banner" class="absolute inset-0 w-full h-full object-cover opacity-20 pointer-events-none" />
    </section>

    <!-- Cursos Disponíveis -->
    <section id="cursos" class="section-light container mx-auto px-6 py-20 md:py-28 relative">
      <div class="blur-blob" style="background: var(--brand-blue); top: -200px; right: -200px;"></div>
      <div class="blur-blob" style="background: var(--brand-orange); bottom: -200px; left: -200px;"></div>
      
      <!-- Cursos com Vagas Abertas -->
      <div class="reveal text-center mb-16">
        <h2 class="text-4xl md:text-5xl font-black mb-4" style="color: var(--text);">Cursos Disponíveis</h2>
        <p class="text-lg" style="color: var(--text-muted);">Inscrições abertas para as próximas turmas</p>
      </div>
      <div id="courses-list-open" class="grid md:grid-cols-2 gap-8 mb-20">
        <!-- Cards de cursos com status 'aberto' -->
        <p class="text-center md:col-span-2 text-gray-500">A carregar cursos...</p>
      </div>

      <!-- Cursos Futuros -->
      <div class="reveal">
        <h3 class="text-3xl font-bold mb-8 text-center" style="color: var(--text);">Em Breve</h3>
        <div id="courses-list-soon" class="grid md:grid-cols-3 gap-6">
          <!-- Cards de cursos com status 'em_breve' -->
           <p class="text-center md:col-span-3 text-gray-500">A carregar futuros cursos...</p>
        </div>
      </div>
    </section>

    <!-- Instrutores - REMOVIDO -->
    <!-- <section id="instrutores" class="section-alt container mx-auto px-6 py-20 md:py-28"> ... </section> -->

    <!-- Sobre -->
    <section id="sobre" class="section-light container mx-auto px-6 py-20 md:py-28">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div class="reveal">
          <h2 class="text-4xl md:text-5xl font-black mb-6" style="color: var(--text);">Excelência e Profissionalismo</h2>
          <p class="text-lg mb-6" style="color: var(--text-muted);">O Programa Evereste Academy é uma iniciativa do Instituto Evereste que oferece experiências imersivas, conteúdos aplicados e uma abordagem voltada à prática. Unimos design moderno, tecnologia e didática para acelerar o desenvolvimento.</p>
          <ul class="space-y-4">
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Instrutores com experiência prática</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Conteúdo atualizado e relevante</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Foco em resultados e aplicabilidade</span></li>
            <li class="flex gap-3"><i class="fa-solid fa-circle-check mt-1" style="color: var(--brand-teal);"></i><span style="color: var(--text);">Certificados reconhecidos</span></li>
          </ul>
        </div>
        <div class="reveal">
          <div class="card-3d p-8">
            <img src="https://i.postimg.cc/SKQh2j5n/logo-evereste-2025-horizontal-2.png" alt="Instituto Evereste" class="w-full h-auto rounded-lg p-6" style="background: rgba(0,102,204,0.03);" />
            <p class="mt-6 text-center font-medium" style="color: var(--text-muted);">Uma iniciativa do Instituto Evereste para formações transformadoras.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="border-t" style="border-color: var(--border); background: var(--surface);">
      <div class="container mx-auto px-6 py-12">
        <div class="flex flex-col md:flex-row items-center justify-between gap-6">
          <div class="text-center md:text-left">
            <p class="text-sm" style="color: var(--text-muted);">© 2025 Evereste Academy. Todos os direitos reservados.</p>
             <!-- Link Política de Privacidade Adicionado -->
            <a href="#" class="text-sm text-blue-600 hover:underline mt-1 inline-block">Política de Privacidade</a>
          </div>
          <div class="flex items-center gap-4">
            <button id="adminBtnFooter" class="btn-ghost text-sm"><i class="fas fa-lock mr-2"></i>Acesso Admin</button>
            <button id="logoutBtnFooter" class="btn-danger text-sm hidden"><i class="fas fa-right-from-bracket mr-2"></i>Logout</button>
            <img src="https://i.postimg.cc/SKQh2j5n/logo-evereste-2025-horizontal-2.png" alt="Instituto Evereste" class="h-8 w-auto" />
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Course Detail View -->
  <div id="course-detail-view" class="hidden">
    <!-- O conteúdo dinâmico será injetado aqui pela função renderCourseDetail() -->
    <p class="text-center p-20">A carregar detalhes do curso...</p>
  </div>
  
  <!-- Admin Panel View -->
  <div id="admin-panel-view" class="hidden">
    <div id="admin-panel">
      <!-- Navegação Lateral do Admin -->
      <nav id="admin-nav" class="flex flex-col flex-shrink-0 p-6">
        <div class="flex items-center gap-3 mb-10 px-4">
          <img src="https://i.postimg.cc/hvvWCwnk/Prancheta-1-1.png" alt="Logo LIDS" class="h-10 w-auto" />
          <span class="font-bold text-lg text-white">Admin</span>
        </div>
        <a href="#dashboard" class="admin-nav-link active" data-target="admin-dashboard">
          <i class="fa-solid fa-chart-line"></i> Dashboard
        </a>
        <a href="#cursos" class="admin-nav-link" data-target="admin-cursos">
          <i class="fa-solid fa-graduation-cap"></i> Cursos
        </a>
        <a href="#matriculas" class="admin-nav-link" data-target="admin-matriculas">
          <i class="fa-solid fa-users"></i> Matrículas
        </a>
        <a href="#instrutores" class="admin-nav-link" data-target="admin-instrutores">
          <i class="fa-solid fa-chalkboard-user"></i> Instrutores
        </a>
        <a href="#certificados" class="admin-nav-link" data-target="admin-certificados">
          <i class="fa-solid fa-certificate"></i> Certificados
        </a>
        <a href="#config" class="admin-nav-link" data-target="admin-config">
          <i class="fa-solid fa-gear"></i> Configurações
        </a>
        <div class="mt-auto">
          <a href="#" id="admin-logout-nav" class="admin-nav-link !border-transparent hover:!bg-red-900/50 hover:!text-red-300">
            <i class="fa-solid fa-right-from-bracket"></i> Sair
          </a>
          <p id="admin-user-email" class="text-xs text-center text-slate-500 mt-4 break-all"></p>
        </div>
      </nav>
      
      <!-- Conteúdo Principal do Admin -->
      <main id="admin-content" class="p-10 overflow-y-auto">
        
        <!-- Seção Dashboard -->
        <section id="admin-dashboard" class="admin-section">
          <h1 class="text-3xl font-bold mb-8">Dashboard</h1>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card-3d !p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Matrículas</h3>
              <p id="stats-total-enrollments" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="card-3d !p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase">Total Check-ins</h3>
              <p id="stats-total-checkins" class="text-3xl font-bold text-teal-600">0</p>
            </div>
            <div class="card-3d !p-6">
              <h3 class="text-sm font-semibold text-gray-500 uppercase">Certificados Emitidos</h3>
              <p id="stats-total-certs" class="text-3xl font-bold text-purple-600">0</p>
            </div>
          </div>
          <div class="card-3d !p-6">
            <h3 class="text-lg font-bold mb-4">Matrículas ao Longo do Tempo</h3>
            <canvas id="enrollmentsChart" height="100"></canvas>
          </div>
        </section>
        
        <!-- Seção Cursos -->
        <section id="admin-cursos" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Gestão de Cursos</h1>
            <button id="admin-add-course-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Novo Curso</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Status</th>
                  <th>Instrutores</th>
                  <th>Data</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-courses-table-body">
                <!-- Linhas de cursos -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Matrículas -->
        <section id="admin-matriculas" class="admin-section hidden">
          <h1 class="text-3xl font-bold mb-8">Gestão de Matrículas</h1>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Protocolo</th>
                  <th>Aluno</th>
                  <th>E-mail</th>
                  <th>Curso</th>
                  <th>Data</th>
                  <th>Setor</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-enrollments-table-body">
                <!-- Linhas de matrículas -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Instrutores -->
        <section id="admin-instrutores" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Gestão de Instrutores</h1>
            <button id="admin-add-instructor-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Adicionar Instrutor</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Foto</th>
                  <th>Nome</th>
                  <th>Título</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-instructors-table-body">
                <!-- Linhas de instrutores -->
              </tbody>
            </table>
          </div>
        </section>
        
        <!-- Seção Certificados -->
        <section id="admin-certificados" class="admin-section hidden">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Gestão de Certificados</h1>
            <button id="admin-add-certificate-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Emitir Novo Certificado</button>
          </div>
          <div class="overflow-x-auto">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID Certificado</th>
                  <th>Aluno</th>
                  <th>E-mail</th>
                  <th>Curso</th>
                  <th>Data Emissão</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="admin-certificates-table-body">
                <!-- Linhas de certificados -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Seção Configurações -->
        <section id="admin-config" class="admin-section hidden">
          <h1 class="text-3xl font-bold mb-8">Configurações</h1>
          <div class="card-3d !p-6 max-w-2xl">
            <h3 class="text-lg font-bold mb-4">Senhas de Check-in</h3>
            <p class="text-sm text-gray-500 mb-6">Defina aqui as senhas que os instrutores irão fornecer aos alunos para o check-in.</p>
            <div id="checkin-passwords-form" class="space-y-4">
              <!-- Campos de senha serão injetados aqui -->
              <p class="text-sm text-gray-400">A carregar senhas dos cursos...</p>
            </div>
            <button id="save-checkin-passwords-btn" class="btn-primary mt-6"><i class="fas fa-save mr-2"></i>Salvar Senhas</button>
          </div>

          <div class="card-3d !p-6 max-w-2xl mt-8">
            <h3 class="text-lg font-bold mb-4">Popular Banco de Dados</h3>
            <p class="text-sm text-gray-500 mb-6">Se o seu banco de dados estiver vazio, clique aqui para adicionar os dados iniciais dos cursos (Fotografia, IA) e dos instrutores. <strong class="text-red-600">Atenção:</strong> Isso pode sobrescrever dados existentes se os IDs forem iguais.</p>
            <button id="populate-db-btn" class="btn-primary"><i class="fas fa-database mr-2"></i>Popular Dados Iniciais</button>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- MODAIS -->

  <!-- Modal Login -->
  <div id="modalLogin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Acesso Administrativo</h3>
          <p class="text-sm" style="color: var(--text-muted);">Área restrita para gestores</p>
        </div>
        <button id="closeLogin" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="loginForm" class="space-y-4">
        <div>
          <label class="admin-label">E-mail</label>
          <input id="loginEmail" type="email" class="admin-input" placeholder="admin@evereste.org" required />
        </div>
        <div>
          <label class="admin-label">Senha</label>
          <input id="loginPassword" type="password" class="admin-input" placeholder="••••••••" required />
        </div>
        <p id="loginError" class="text-red-600 text-sm hidden">Erro ao fazer login.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base"><i class="fa-solid fa-right-to-bracket mr-2"></i>Entrar</button>
      </form>
    </div>
  </div>

  <!-- Modal Inscrição -->
  <div id="modalEnroll" class="modal-backdrop">
    <!-- Tamanho do Modal aumentado para acomodar os checkboxes -->
    <div class="modal-card modal-card-md p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Formulário de Inscrição</h3>
          <p class="text-sm" style="color: var(--text-muted);">Inscreva-se no curso: <strong id="enrollCourseName" class="text-blue-600"></strong></p>
        </div>
        <button id="closeEnroll" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="enrollForm" class="space-y-4">
        <div>
          <label class="admin-label">Nome Completo</label>
          <input id="enrollName" type="text" class="admin-input" placeholder="O seu nome" required />
        </div>
        <div>
          <label class="admin-label">E-mail</label>
          <input id="enrollEmail" type="email" class="admin-input" placeholder="voce@email.com" required />
        </div>
        <div>
          <label class="admin-label">Telefone</label>
          <input id="enrollPhone" type="tel" class="admin-input" placeholder="(00) 00000-0000" required />
        </div>
        <div>
          <label class="admin-label">Setor</label>
          <input id="enrollSector" type="text" class="admin-input" placeholder="Ex: Comunicação, Pedagógico..." required />
        </div>

        <!-- Checkboxes de Consentimento Adicionados -->
        <div class="space-y-3 pt-2">
           <label class="consent-label">
             <input type="checkbox" id="enrollConsentImage" name="consentImage" required>
             <span>Autorizo o uso da minha imagem em materiais de divulgação relacionados a esta capacitação, conforme <a href="#" target="_blank">Termo de Uso de Imagem</a>.</span>
           </label>
           <label class="consent-label">
             <input type="checkbox" id="enrollConsentLGPD" name="consentLGPD" required>
             <span>Li e concordo com a <a href="#" target="_blank">Política de Privacidade</a> e autorizo o tratamento dos meus dados para fins desta inscrição, conforme a LGPD.</span>
           </label>
        </div>

        <p id="enrollError" class="text-red-600 text-sm hidden">Erro ao processar inscrição. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="enrollSubmitBtnText"><i class="fa-solid fa-paper-plane mr-2"></i>Confirmar Inscrição</span>
          <span id="enrollSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A processar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Sucesso Inscrição (Protocolo) -->
  <div id="modalEnrollSuccess" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8 text-center">
      <div class="text-center">
        <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
        <h3 class="text-2xl font-bold" style="color: var(--text);">Inscrição Confirmada!</h3>
        <p class="text-base mt-2" style="color: var(--text-muted);">Guarde o seu número de protocolo:</p>
        <p id="enrollProtocol" class="text-3xl font-bold text-blue-600 bg-blue-50 border-2 border-blue-200 rounded-lg py-4 my-4"></p>
        <p class="text-sm" style="color: var(--text-muted);">Você receberá os detalhes da inscrição no seu e-mail.</p>
      </div>
      <button id="closeEnrollSuccess" class="btn-primary w-full mt-6">Fechar</button>
    </div>
  </div>

  <!-- Modal Check-in -->
  <div id="modalCheckin" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Check-in do Curso</h3>
          <p class="text-sm" style="color: var(--text-muted);">Insira a senha fornecida pelo instrutor.</p>
        </div>
        <button id="closeCheckin" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="checkinForm" class="space-y-4">
        <div>
          <label class="admin-label">Senha de Acesso</label>
          <input id="checkinPassword" type="password" class="admin-input" placeholder="••••••••" required />
        </div>
        <p id="checkinError" class="text-red-600 text-sm hidden">Senha incorreta. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="checkinSubmitBtnText">Validar Check-in</span>
          <span id="checkinSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A validar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Avaliar Instrutor -->
  <div id="modalRating" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Avaliar Instrutor</h3>
          <p class="text-sm" style="color: var(--text-muted);">O seu feedback é importante para nós.</p>
        </div>
        <button id="closeRating" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="ratingForm" class="space-y-4">
        <div>
          <label class="admin-label">Selecione o Instrutor</label>
          <select id="ratingInstructorSelect" class="admin-select" required>
            <!-- Opções de instrutores -->
          </select>
        </div>
        <div>
          <label class="admin-label">A sua avaliação (1 a 5 estrelas)</label>
          <div id="ratingStars" class="flex text-3xl text-gray-300 cursor-pointer">
            <i class="fa-solid fa-star" data-value="1"></i>
            <i class="fa-solid fa-star" data-value="2"></i>
            <i class="fa-solid fa-star" data-value="3"></i>
            <i class="fa-solid fa-star" data-value="4"></i>
            <i class="fa-solid fa-star" data-value="5"></i>
          </div>
          <input type="hidden" id="ratingValue" value="0" required>
        </div>
         <div>
          <label class="admin-label">Comentário (Opcional)</label>
          <textarea id="ratingComment" class="admin-textarea" rows="3" placeholder="O que achou da didática?"></textarea>
        </div>
        <p id="ratingError" class="text-red-600 text-sm hidden">Erro ao enviar. Tente novamente.</p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="ratingSubmitBtnText">Enviar Avaliação</span>
          <span id="ratingSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A enviar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Verificação de Certificado -->
  <div id="modalCertificateCheck" class="modal-backdrop">
    <div class="modal-card modal-card-sm p-8">
      <div class="flex items-start justify-between mb-6">
        <div>
          <h3 class="text-2xl font-bold" style="color: var(--text);">Verificar Certificado</h3>
          <p class="text-sm" style="color: var(--text-muted);">Insira o e-mail que usou na inscrição.</p>
        </div>
        <button id="closeCertificateCheck" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="certificateCheckForm" class="space-y-4">
        <div>
          <label class="admin-label">E-mail de Inscrição</label>
          <input id="certificateCheckEmail" type="email" class="admin-input" placeholder="voce@email.com" required />
        </div>
        <!-- Mensagem de resultado (agora também contém o botão) -->
        <div id="certificateCheckResult" class="hidden"></div>
        <p id="certificateCheckError" class="text-red-600 text-sm hidden"></p>
        <button type="submit" class="btn-primary w-full !py-3 !text-base">
          <span id="certificateCheckSubmitBtnText">Verificar Disponibilidade</span>
          <span id="certificateCheckSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A verificar...</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Editar Curso -->
  <div id="modalEditCourse" class="modal-backdrop">
    <div class="modal-card modal-card-xl p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalCourseTitle" class="text-2xl font-bold" style="color: var(--text);"></h3>
        <button id="closeEditCourse" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="courseForm" class="space-y-6">
        <input type="hidden" id="courseId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="courseTitle">Título</label>
            <input class="admin-input" type="text" id="courseTitle" required>
          </div>
          <div>
            <label class="admin-label" for="courseSubtitle">Subtítulo</label>
            <input class="admin-input" type="text" id="courseSubtitle" required>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="admin-label" for="courseThemeColor">Cor (Hex)</label>
            <input class="admin-input" type="text" id="courseThemeColor" placeholder="#FFC107" required>
          </div>
          <div>
            <label class="admin-label" for="courseIcon">Ícone (FontAwesome)</label>
            <input class="admin-input" type="text" id="courseIcon" placeholder="fa-camera-retro" required>
          </div>
          <div>
            <label class="admin-label" for="courseStatus">Status</label>
            <select id="courseStatus" class="admin-select" required>
              <option value="aberto">Vagas Abertas</option>
              <option value="em_breve">Em Breve</option>
              <option value="fechado">Fechado</option>
            </select>
          </div>
        </div>
         <div>
            <label class="admin-label" for="courseHeaderImage">URL Imagem Capa</label>
            <input class="admin-input" type="text" id="courseHeaderImage" placeholder="https://url-da-imagem.com/capa.jpg" required>
          </div>
        <div>
          <label class="admin-label" for="courseSummary">Resumo (Card)</label>
          <textarea class="admin-textarea" id="courseSummary" rows="2" required></textarea>
        </div>
        <div>
          <label class="admin-label" for="courseFullDescription">Descrição Completa</label>
          <textarea class="admin-textarea" id="courseFullDescription" rows="3" required></textarea>
        </div>
        <div>
          <label class="admin-label" for="courseTargetAudience">Público-alvo</label>
          <textarea class="admin-textarea" id="courseTargetAudience" rows="2" required></textarea>
        </div>
        
        <!-- JSON Fields -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="courseDetails">Detalhes (JSON)</label>
            <textarea class="admin-textarea" id="courseDetails" rows="5" placeholder='{ "Data": "TBA", "Carga": "4h" }' required></textarea>
          </div>
          <div>
            <label class="admin-label" for="courseLearningObjectives">Objetivos (JSON)</label>
            <textarea class="admin-textarea" id="courseLearningObjectives" rows="5" placeholder='[ "Aprender X", "Fazer Y" ]' required></textarea>
          </div>
          <div>
            <label class="admin-label" for="courseRequirements">Requisitos (JSON)</label>
            <textarea class="admin-textarea" id="courseRequirements" rows="5" placeholder='[ "Trazer notebook", "Saber Z" ]' required></textarea>
          </div>
           <div>
            <label class="admin-label" for="courseModules">Módulos (JSON)</label>
            <textarea class="admin-textarea" id="courseModules" rows="5" placeholder='[ { "title": "Módulo 1", "topics": ["Tópico 1"] } ]' required></textarea>
          </div>
          <div class="md:col-span-2">
            <label class="admin-label" for="coursePracticalActivities">Atividades Práticas (JSON)</label>
            <textarea class="admin-textarea" id="coursePracticalActivities" rows="5" placeholder='[ { "title": "Atividade 1", "description": "Fazer X" } ]' required></textarea>
          </div>
        </div>
        
        <!-- Instructors Selection -->
        <div>
          <label class="admin-label">Instrutores</label>
          <div id="courseInstructorsList" class="checkbox-list">
            <!-- Checkboxes de instrutores -->
          </div>
        </div>
        
        <!-- Material Upload -->
        <div>
          <label class="admin-label">Material do Curso (Opcional)</label>
          <p class="text-sm text-gray-500 mb-2">Envie o PDF, ZIP, ou outro material para download. Se já existir um, enviar um novo irá substituí-lo.</p>
          <input class="admin-input" type="file" id="courseMaterialFile" accept=".pdf,.zip,.rar,.doc,.docx,.ppt,.pptx,.xls,.xlsx">
          <p id="courseMaterialCurrent" class="text-sm text-gray-500 mt-2"></p>
        </div>

        <p id="courseFormError" class="text-red-600 text-sm hidden">Erro. Verifique os campos.</p>
        
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="courseFormCancel" class="btn-ghost">Cancelar</button>
          <button type="submit" class="btn-primary">
            <span id="courseSubmitBtnText">Salvar Curso</span>
            <span id="courseFormSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A salvar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Editar Instrutor -->
  <div id="modalEditInstructor" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalInstructorTitle" class="text-2xl font-bold" style="color: var(--text);"></h3>
        <button id="closeEditInstructor" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="instructorForm" class="space-y-6">
        <input type="hidden" id="instructorId">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="instructorName">Nome</label>
            <input class="admin-input" type="text" id="instructorName" required>
          </div>
           <div>
            <label class="admin-label" for="instructorTitle">Título</label>
            <input class="admin-input" type="text" id="instructorTitle" placeholder="Ex: Supervisor de Marketing" required>
          </div>
        </div>
        <div>
            <label class="admin-label" for="instructorImage">URL da Foto</label>
            <input class="admin-input" type="text" id="instructorImage" placeholder="https://url-da-foto.com/perfil.jpg" required>
        </div>
        <div>
          <label class="admin-label" for="instructorBio">Biografia (Card)</label>
          <textarea class="admin-textarea" id="instructorBio" rows="3" placeholder="Pequena descrição que aparece no card..."></textarea>
        </div>
        
        <p id="instructorFormError" class="text-red-600 text-sm hidden">Erro. Verifique os campos.</p>
        
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="instructorFormCancel" class="btn-ghost">Cancelar</button>
          <button type="submit" class="btn-primary">
            <span id="instructorSubmitBtnText">Salvar Instrutor</span>
            <span id="instructorFormSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A salvar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Admin: Emitir Certificado -->
  <div id="modalEditCertificate" class="modal-backdrop">
    <div class="modal-card modal-card-lg p-8">
      <div class="flex items-start justify-between mb-6">
        <h3 id="modalCertificateTitle" class="text-2xl font-bold" style="color: var(--text);"></h3>
        <button id="closeEditCertificate" class="btn-ghost !p-2 !text-lg"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="certificateForm" class="space-y-6">
        <input type="hidden" id="certificateId">
        
        <div>
          <label class="admin-label" for="certificateStudentName">Nome do Aluno</label>
          <input class="admin-input" type="text" id="certificateStudentName" placeholder="Nome completo do aluno" required>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="certificateStudentEmail">E-mail do Aluno (Para Verificação)</label>
            <input class="admin-input" type="email" id="certificateStudentEmail" placeholder="email@aluno.com" required>
          </div>
          <div>
            <label class="admin-label" for="certificateStudentId">ID do Aluno (Opcional)</label>
            <input class="admin-input" type="text" id="certificateStudentId" placeholder="UID do usuário se houver">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="admin-label" for="certificateCourseName">Nome do Curso</label>
            <input class="admin-input" type="text" id="certificateCourseName" required>
          </div>
          <div>
            <label class="admin-label" for="certificateCourseId">ID do Curso</label>
            <input class="admin-input" type="text" id="certificateCourseId" placeholder="Ex: fotografia" required>
          </div>
        </div>
        <div>
            <label class="admin-label" for="certificateIssuedAt">Data de Emissão</label>
            <input class="admin-input" type="date" id="certificateIssuedAt" required>
        </div>
        
        <!-- NOVOS CAMPOS DE UPLOAD DE CERTIFICADO -->
        <div class="mt-4 pt-4 border-t border-gray-200">
          <label class="admin-label" for="certificateFile">Arquivo PDF do Certificado</label>
          <p class="text-sm text-gray-500 mb-2">Envie o PDF pronto. Se já existir um, enviar um novo irá substituí-lo.</p>
          <input class="admin-input" type="file" id="certificateFile" accept=".pdf">
          <p id="certificateCurrentFile" class="text-sm text-gray-500 mt-2"></p>
        </div>
        
        <p id="certificateFormError" class="text-red-600 text-sm hidden">Erro. Verifique os campos.</p>
        
        <div class="flex justify-end gap-4 pt-4">
          <button type="button" id="certificateFormCancel" class="btn-ghost">Cancelar</button>
          <button type="submit" class="btn-primary">
            <span id="certificateSubmitBtnText">Salvar Certificado</span>
            <span id="certificateFormSpinner" class="hidden"><i class="fas fa-spinner animate-spin mr-2"></i>A salvar...</span>
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- SCRIPTS -->

  <!-- Firebase -->
  <script type="module">
    // Importar funções do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      signInAnonymously,
      signInWithCustomToken
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      addDoc,
      updateDoc,
      deleteDoc,
      collection,
      query,
      where,
      getDocs,
      onSnapshot,
      Timestamp,
      writeBatch,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        deleteObject
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // === CONFIGURAÇÃO E INICIALIZAÇÃO ===
    
    // Configuração do Firebase
    // As variáveis __firebase_config e __app_id são injetadas pelo ambiente.
    let firebaseConfig;
    let appId;

    try {
      // Tenta usar as variáveis injetadas
      firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Fallback (plano B) se as variáveis não forem injetadas
      if (!firebaseConfig.apiKey) {
        console.warn("Variáveis de ambiente não encontradas, usando fallback.");
        firebaseConfig = {
          apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
          authDomain: "academylids.firebaseapp.com",
          projectId: "academylids",
          storageBucket: "academylids.firebasestorage.app",
          messagingSenderId: "826478835273",
          appId: "1:826478835273:web:0995d64419276b932cb198",
          measurementId: "G-T2TN7FL590"
        };
        appId = 'default-app-id'; // Use um appId de fallback se necessário
      }

    } catch (e) {
      console.error("Erro ao parsear configuração do Firebase:", e);
      // Fallback crítico em caso de erro de parse
      firebaseConfig = {
        apiKey: "AIzaSyB0xvVzytOx4dumokND-dr926krSO4-CqU",
        authDomain: "academylids.firebaseapp.com",
        projectId: "academylids",
        storageBucket: "academylids.firebasestorage.app",
        messagingSenderId: "826478835273",
        appId: "1:826478835273:web:0995d64419276b932cb198",
        measurementId: "G-T2TN7FL590"
      };
      appId = 'default-app-id';
    }
    
    // Adicionado: Log da configuração usada
    console.log('Using Firebase Config:', firebaseConfig);
    console.log('Using App ID:', appId);


    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Estado da Aplicação
    let currentUser = null;
    let isAdmin = false;
    let localCourses = []; // Cache local de cursos
    let localInstructors = []; // Cache local de instrutores
    let userCheckins = {}; // Cache de check-ins do usuário
    let currentCourseId = null; // ID do curso na página de detalhes
    
    // Referências de Coleções (Baseado nas Regras)
    const coursesCollection = collection(db, `artifacts/${appId}/public/data/courses`);
    const instructorsCollection = collection(db, `artifacts/${appId}/public/data/instructors`);
    const enrollmentsCollection = collection(db, `artifacts/${appId}/public/data/enrollments`);
    const checkinsCollection = collection(db, `artifacts/${appId}/public/data/checkins`);
    const passwordsCollection = collection(db, `artifacts/${appId}/public/data/checkinPasswords`);
    const certificatesCollection = collection(db, `artifacts/${appId}/public/data/certificates`);
    const ratingsCollection = collection(db, `artifacts/${appId}/public/data/ratings`);
    const adminsCollection = collection(db, 'admins'); // Coleção raiz

    // === GESTÃO DE ESTADO E UI ===

    // Elementos DOM
    const mainView = document.getElementById('main-view');
    const courseDetailView = document.getElementById('course-detail-view');
    const adminPanelView = document.getElementById('admin-panel-view');
    const coursesListOpen = document.getElementById('courses-list-open');
    const coursesListSoon = document.getElementById('courses-list-soon');
    // const instructorsList = document.getElementById('instructors-list'); // Removido

    // Botões de Admin/Logout
    const adminBtnHeader = document.getElementById('adminBtnHeader');
    const logoutBtnHeader = document.getElementById('logoutBtnHeader');
    const adminBtnFooter = document.getElementById('adminBtnFooter');
    const logoutBtnFooter = document.getElementById('logoutBtnFooter');
    const adminLogoutNav = document.getElementById('admin-logout-nav');
    const adminUserEmail = document.getElementById('admin-user-email');

    // Modais
    const modalLogin = document.getElementById('modalLogin');
    const modalEnroll = document.getElementById('modalEnroll');
    const modalEnrollSuccess = document.getElementById('modalEnrollSuccess');
    const modalCheckin = document.getElementById('modalCheckin');
    const modalRating = document.getElementById('modalRating');
    const modalCertificateCheck = document.getElementById('modalCertificateCheck');
    const modalEditCourse = document.getElementById('modalEditCourse');
    const modalEditInstructor = document.getElementById('modalEditInstructor');
    const modalEditCertificate = document.getElementById('modalEditCertificate');

    // Função para mostrar/esconder o painel de Admin
    function setAdminUI(isAdmin) {
      if (isAdmin) {
        adminBtnHeader.textContent = "Painel Admin";
        adminBtnHeader.onclick = () => showView('admin');
        adminBtnFooter.textContent = "Painel Admin";
        adminBtnFooter.onclick = () => showView('admin');
        logoutBtnHeader.classList.remove('hidden');
        logoutBtnFooter.classList.remove('hidden');
        adminUserEmail.textContent = currentUser ? currentUser.email : '';
      } else {
        adminBtnHeader.textContent = "Admin";
        adminBtnHeader.onclick = () => _openModal(modalLogin);
        adminBtnFooter.textContent = "Acesso Admin";
        adminBtnFooter.onclick = () => _openModal(modalLogin);
        logoutBtnHeader.classList.add('hidden');
        logoutBtnFooter.classList.add('hidden');
      }
    }
    
    // Função para navegar entre as vistas
    function showView(viewName) {
      mainView.classList.add('hidden');
      courseDetailView.classList.add('hidden');
      adminPanelView.classList.add('hidden');

      if (viewName === 'main') {
        mainView.classList.remove('hidden');
        window.scrollTo(0, 0);
      } else if (viewName === 'detail') {
        courseDetailView.classList.remove('hidden');
        window.scrollTo(0, 0);
      } else if (viewName === 'admin') {
        if (isAdmin) {
          adminPanelView.classList.remove('hidden');
          window.scrollTo(0, 0);
        } else {
          // Se não for admin, volta para a main e abre o login
          mainView.classList.remove('hidden');
          _openModal(modalLogin);
        }
      }
    }

    // Função para mostrar notificações (toast)
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
      toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
      
      toast.innerHTML = `
        <i class="fas ${iconClass} icon"></i>
        <span class="toast-message">${message}</span>
        <button class="toast-close">&times;</button>
      `;
      
      container.appendChild(toast);
      
      // Animação de entrada
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Fechar
      const closeBtn = toast.querySelector('.toast-close');
      const closeToast = () => {
        toast.classList.remove('show');
        // Remover da DOM após a animação
        setTimeout(() => toast.remove(), 500);
      };
      
      closeBtn.onclick = closeToast;
      // Fechar automaticamente
      setTimeout(closeToast, 5000);
    }

    // === AUTENTICAÇÃO ===

    onAuthStateChanged(auth, async (user) => {
      // Tentativa de login com Custom Token (se injetado)
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && !auth.currentUser) {
          try {
              console.log("A tentar login com Custom Token...");
              await signInWithCustomToken(auth, __initial_auth_token);
              // O onAuthStateChanged será chamado novamente com o usuário logado
              return; // Saia por agora, deixe o próximo onAuthStateChanged tratar
          } catch (error) {
              console.error("Erro no login com Custom Token:", error);
              // Continua para login anônimo se o token falhar
          }
      }
      
      if (user) {
        // Usuário está logado
        currentUser = user;
        
        if (user.isAnonymous) {
          console.log("Usuário logado anonimamente:", user.uid);
          isAdmin = false;
          setAdminUI(false);
        } else {
          console.log("Usuário logado:", user.email);
          // É um usuário com e-mail, verificar se é admin
          await checkAdminStatus(user.uid);
          setAdminUI(isAdmin);
          if (isAdmin) {
            // Se for admin, carrega dados do painel
            loadAdminDashboardData();
          }
        }
        
        // Carregar dados públicos (cursos, instrutores)
        // Isso agora acontece DEPOIS que a autenticação (anônima ou não) foi estabelecida
        loadCourses();
        loadInstructors(); // Ainda carrega para usar no modal de curso
        
        // Carregar dados privados do usuário (check-ins)
        loadUserCheckins(user.uid);
        
      } else {
        // Usuário está deslogado
        console.log("Nenhum usuário logado. A tentar login anônimo...");
        currentUser = null;
        isAdmin = false;
        setAdminUI(false);
        
        // Tentar login anônimo para ter permissão de leitura
        try {
          await signInAnonymously(auth);
          // O onAuthStateChanged será chamado novamente com o usuário anônimo
        } catch (error) {
          console.error("Erro no login anônimo:", error);
          showToast("Não foi possível conectar. Verifique a sua rede.", "error");
        }
      }
    });

    // Função de verificação de Admin
    async function checkAdminStatus(uid) {
      try {
        const adminDocRef = doc(db, 'admins', uid);
        const adminDoc = await getDoc(adminDocRef);
        isAdmin = adminDoc.exists();
        console.log(`Status de Admin para ${uid}: ${isAdmin}`);
      } catch (error) {
         // MUDANÇA: Tratar erro de permissão como "não-admin" sem poluir a consola
        if (error.code === 'permission-denied' || error.message.includes('Missing or insufficient permissions')) {
          console.log("Verificação de admin falhou (permissão negada - esperado para não-admins).");
          isAdmin = false;
        } else {
          // Outros erros ainda são registados
          console.error("Erro ao verificar status de admin (inesperado):", error); // Modificado para indicar que é inesperado
          isAdmin = false;
        }
      } 
    } 

    // Formulário de Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      
      try {
        errorEl.classList.add('hidden');
        // Adicionado: Log antes da tentativa
        console.log('Attempting login for:', email); 
        await signInWithEmailAndPassword(auth, email, password);
        // Sucesso! O onAuthStateChanged vai tratar o resto
        _closeModal(modalLogin);
        showView('admin'); // Força a ida ao painel admin
        showToast("Login bem-sucedido!", "success");
      } catch (error) {
        console.error("Erro de login:", error.code, error.message); // Log mais detalhado
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
          errorEl.textContent = "E-mail ou senha inválidos.";
        } else if (error.code === 'auth/operation-not-allowed') {
          errorEl.textContent = "Login por email/senha não está ativado neste projeto Firebase. Verifique o Console.";
        } else {
          errorEl.textContent = `Erro: ${error.code || error.message}`;
        }
        errorEl.classList.remove('hidden');
      }
    });

    // Funções de Logout
    function handleLogout() {
      signOut(auth).then(() => {
        isAdmin = false;
        currentUser = null; // Limpa o usuário atual
        setAdminUI(false);
        showView('main');
        showToast("Logout efetuado com sucesso.", "success");
        // Tenta login anônimo novamente após logout
        signInAnonymously(auth).catch(err => console.error("Erro no login anônimo pós-logout:", err));
      }).catch((error) => {
        console.error("Erro no logout:", error);
        showToast("Erro ao fazer logout.", "error");
      });
    }
    [logoutBtnHeader, logoutBtnFooter, adminLogoutNav].forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        handleLogout();
      });
    });

    // === CARREGAMENTO DE DADOS (PÁGINA PÚBLICA) ===

    // Carregar Cursos
    async function loadCourses() {
      try {
        const querySnapshot = await getDocs(coursesCollection);
        localCourses = [];
        querySnapshot.forEach((doc) => {
          localCourses.push({ id: doc.id, ...doc.data() });
        });
        renderCoursesLists();
      } catch (error) {
        console.error("Erro ao carregar cursos:", error);
        coursesListOpen.innerHTML = `<p class="text-center md:col-span-2 text-red-500">Erro ao carregar cursos: ${error.message}</p>`;
      }
    }

    // Renderizar Cursos nas Listas
    function renderCoursesLists() {
      coursesListOpen.innerHTML = '';
      coursesListSoon.innerHTML = '';
      
      const openCourses = localCourses.filter(c => c.status === 'aberto');
      const soonCourses = localCourses.filter(c => c.status === 'em_breve');

      if (openCourses.length === 0) {
        coursesListOpen.innerHTML = '<p class="text-center md:col-span-2 text-gray-500">Nenhum curso com vagas abertas no momento.</p>';
      } else {
        openCourses.forEach(course => {
          const cardHTML = `
            <article class="card-3d p-8 reveal stagger-1 cursor-pointer course-card-solid" data-course-id="${course.id}" style="background: ${course.themeColor}; color: white;">
              <div class="flex items-center gap-3 mb-4">
                <i class="fa-solid ${course.icon} text-3xl"></i>
                <div>
                  <h3 class="text-2xl font-bold">${course.title}</h3>
                  <p class="text-sm opacity-90">${course.subtitle}</p>
                </div>
              </div>
              <div class="overflow-hidden rounded-lg mb-4">
                <img src="${course.headerOverlayImage}" alt="${course.title}" class="w-full h-48 object-cover opacity-80" />
              </div>
              <p class="mb-6 opacity-90">${course.summary}</p>
              <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-bold py-3 px-4 rounded-lg transition-all"><i class="fa-solid fa-arrow-right mr-2"></i>Ver Detalhes</button>
            </article>
          `;
          coursesListOpen.innerHTML += cardHTML;
        });
      }
      
      if (soonCourses.length === 0) {
        coursesListSoon.innerHTML = '<p class="text-center md:col-span-3 text-gray-500">Nenhum curso previsto por enquanto.</p>';
      } else {
         soonCourses.forEach(course => {
           const instructorsText = (course.instructors && course.instructors.length > 0)
                                 ? course.instructors.map(i => i.name).join(', ')
                                 : 'Instrutores a definir';
           const cardHTML = `
            <div class="card-3d p-6 course-card-solid" style="background: ${course.themeColor || 'var(--brand-purple)'};">
              <span class="badge-soon mb-3" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white;"><i class="fa-solid fa-clock mr-2"></i>Em breve</span>
              <h4 class="font-bold text-lg mb-2">${course.title}</h4>
              <p class="text-sm opacity-90">${instructorsText}</p>
            </div>
           `;
           coursesListSoon.innerHTML += cardHTML;
         });
      }
      
      // Re-ativar animações
      _setupRevealAnimations();
    }
    
    // Carregar Instrutores (apenas para cache local)
    async function loadInstructors() {
      try {
        const querySnapshot = await getDocs(instructorsCollection);
        localInstructors = []; // Limpa o cache local
        querySnapshot.forEach((doc) => {
          localInstructors.push({ id: doc.id, ...doc.data() });
        });
        console.log("Instrutores carregados no cache:", localInstructors.length);
      } catch (error) {
        console.error("Erro ao carregar instrutores para cache:", error);
      }
    }

    // Carregar Check-ins do Usuário
    async function loadUserCheckins(uid) {
      if (!uid) return;
      try {
        const q = query(checkinsCollection, where("userId", "==", uid));
        const querySnapshot = await getDocs(q);
        userCheckins = {};
        querySnapshot.forEach((doc) => {
          userCheckins[doc.data().courseId] = true;
        });
        console.log("Check-ins do usuário carregados:", userCheckins);
      } catch (error) {
        console.error("Erro ao carregar check-ins:", error);
      }
    }

    // === PÁGINA DE DETALHES DO CURSO ===
    
    function renderCourseDetail(course) {
      currentCourseId = course.id;
      const themeColor = course.themeColor || '#0066CC';
      const themeColorDark = course.themeColorDark || '#004C99';

      // Gerar HTML dinâmico
      const detailsHTML = Object.entries(course.details || {}).map(([key, value]) => `
        <div class="flex items-start">
          <i class="fas fa-check mt-1 mr-3" style="color: ${themeColor};"></i>
          <span><strong>${key}:</strong> ${value}</span>
        </div>
      `).join('');

      const instructorsHTML = (course.instructors || []).map(instructor => `
        <div class="flex items-center space-x-4">
          <img class="h-16 w-16 rounded-full object-cover" src="${instructor.image}" alt="${instructor.name}">
          <div>
            <p class="font-bold text-gray-800">${instructor.name}</p>
            <p class="text-sm text-gray-500">${instructor.title}</p>
            ${instructor.bio ? `<p class="text-xs text-gray-400 mt-1">${instructor.bio}</p>` : ''}
          </div>
        </div>
      `).join('');

      const modulesHTML = (course.modules || []).map(module => `
        <div class="bg-gray-50 p-5 rounded-lg border-l-4" style="border-color: ${themeColor};">
          <h4 class="font-bold text-lg" style="color: var(--primary);">${module.title}</h4>
          <ul class="mt-3 space-y-2 list-disc list-inside text-gray-600">
            ${(module.topics || []).map(topic => `<li>${topic}</li>`).join('')}
          </ul>
        </div>
      `).join('');

      const practicalActivitiesHTML = (course.practicalActivities || []).map(activity => `
        <div class="bg-white p-5 rounded-lg border border-gray-200">
          <h4 class="font-bold flex items-center text-lg" style="color: ${themeColor};"><i class="fas fa-flask mr-3"></i>${activity.title}</h4>
          <p class="text-gray-600 mt-2 pl-8">${activity.description}</p>
        </div>
      `).join('');

      // Construir o HTML final da página
      const courseHTML = `
        <section class="relative text-white py-20 md:py-32 overflow-hidden course-detail-hero" style="background: linear-gradient(-45deg, ${themeColor}, ${themeColorDark}, ${themeColor});">
          <div class="absolute inset-0 bg-cover bg-center opacity-20" style="background-image: url('${course.headerOverlayImage}');"></div>
          <div class="container mx-auto px-6 relative">
            <p class="text-lg font-semibold mb-2"><i class="fas ${course.icon} mr-2"></i>Evereste Academy</p>
            <h1 class="text-4xl md:text-6xl font-extrabold leading-tight">${course.title}</h1>
            <p class="mt-2 text-xl md:text-2xl opacity-90">${course.subtitle}</p>
          </div>
        </section>
        
        <div class="container mx-auto px-6 py-16 course-detail-content">
          <button id="back-to-courses-btn" class="mb-12 font-semibold hover:underline" style="color: ${themeColor};">
            <i class="fas fa-arrow-left mr-2"></i>Voltar para todos os cursos
          </button>
          
          <div class="grid lg:grid-cols-3 gap-12">
            <!-- Coluna de Conteúdo Principal -->
            <div class="lg:col-span-2">
              <h2 class="text-2xl font-bold text-gray-800 mb-4">Sobre a atividade</h2>
              <p class="text-gray-600 leading-relaxed mb-8">${course.fullDescription}</p>
              
              <h2 class="text-2xl font-bold text-gray-800 mb-4">O que irá aprender</h2>
              <ul class="space-y-3 mb-8">${(course.learningObjectives || []).map(obj => `<li class="flex items-start"><i class="fas fa-check-circle mt-1 mr-3" style="color: ${themeColor};"></i><span>${obj}</span></li>`).join('')}</ul>
              
              <h2 class="text-2xl font-bold text-gray-800 mb-6 mt-12">Conteúdo Programático</h2>
              <div class="space-y-6 mb-12">${modulesHTML}</div>
              
              <h2 class="text-2xl font-bold text-gray-800 mb-6">Atividades Práticas</h2>
              <div class="space-y-4 mb-12">${practicalActivitiesHTML}</div>

              <h2 class="text-2xl font-bold text-gray-800 mb-4">Requisitos</h2>
              <ul class="space-y-3">${(course.requirements || []).map(req => `<li class="flex items-start"><i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i><span>${req}</span></li>`).join('')}</ul>
            </div>
            
            <!-- Coluna Lateral (Sidebar) -->
            <div class="lg:col-span-1">
              <div class="bg-white p-6 rounded-lg shadow-xl sticky top-24">
                <span class="inline-block text-sm font-semibold mb-4 px-3 py-1 rounded-full" style="background-color: ${themeColor}20; color: ${themeColor};">Inscrições abertas</span>
                <h3 class="text-xl font-bold mb-4" style="color: var(--primary);">${course.title}</h3>
                <div class="space-y-3 mb-6 text-gray-700">${detailsHTML}</div>
                
                <div class="space-y-3 flex flex-col">
                  <button id="enroll-btn-detail" class="btn-primary w-full" style="background: ${themeColor}; border: none;">
                    <i class="fas fa-paper-plane mr-2"></i>Inscreva-se
                  </button>
                  <button id="checkin-btn-detail" class="btn-primary w-full">
                    <i class="fas fa-check-circle mr-2"></i>Fazer Check-in
                  </button>
                  <button id="materials-btn-detail" class="btn-primary w-full btn-disabled">
                    <i class="fas fa-download mr-2"></i>Materiais
                  </button>
                  <button id="rating-btn-detail" class="btn-primary w-full btn-disabled">
                    <i class="fas fa-star mr-2"></i>Avaliar Instrutor
                  </button>
                  <button id="certificate-btn-detail" class="btn-primary w-full">
                    <i class="fas fa-certificate mr-2"></i>Certificado
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="mt-16 pt-8 border-t">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Instrutores</h2>
            <div class="flex flex-col md:flex-row gap-8">${instructorsHTML || 'Nenhum instrutor associado.'}</div>
          </div>
          
          <div class="mt-16 pt-8 border-t">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Público-alvo</h2>
            <p class="text-gray-600">${course.targetAudience || 'Não especificado.'}</p>
          </div>
        </div>
      `;
      
      courseDetailView.innerHTML = courseHTML;
      showView('detail');
      
      // Atualizar estado dos botões (habilitar/desabilitar)
      updateCourseDetailButtons(course);
    }
    
    // Atualizar botões da página de detalhes (Check-in, Materiais, etc.)
    function updateCourseDetailButtons(course) {
      const hasCheckedIn = userCheckins[course.id];
      const hasMaterials = course.materials && course.materials.length > 0;

      const checkinBtn = document.getElementById('checkin-btn-detail');
      const materialsBtn = document.getElementById('materials-btn-detail');
      const ratingBtn = document.getElementById('rating-btn-detail');
      const certificateBtn = document.getElementById('certificate-btn-detail'); // Botão sempre ativo
      
      if (hasCheckedIn) {
        checkinBtn.innerHTML = '<i class="fas fa-check-double mr-2"></i>Check-in Realizado';
        checkinBtn.classList.add('btn-disabled');
        
        // Habilitar botões pós-check-in
        ratingBtn.classList.remove('btn-disabled');
        
        if (hasMaterials) {
          materialsBtn.classList.remove('btn-disabled');
          materialsBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Materiais';
        } else {
          materialsBtn.innerHTML = '<i class="fas fa-times-circle mr-2"></i>Sem Materiais';
          materialsBtn.classList.add('btn-disabled'); // Desabilita se não há materiais
        }
        
      } else {
        checkinBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Fazer Check-in';
        checkinBtn.classList.remove('btn-disabled');
        
        materialsBtn.classList.add('btn-disabled');
        materialsBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Materiais'; // Texto padrão
        ratingBtn.classList.add('btn-disabled');
      }
    }


    // === INTERAÇÕES DO USUÁRIO (Modais Públicos) ===

    // Abrir Modal de Inscrição
    function openEnrollModal(courseId, courseName) {
      currentCourseId = courseId;
      document.getElementById('enrollCourseName').textContent = courseName;
      document.getElementById('enrollForm').reset(); // Limpa o formulário
      document.getElementById('enrollError').classList.add('hidden');
      _openModal(modalEnroll);
    }

    // Submeter Inscrição
    document.getElementById('enrollForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showToast("Erro: Usuário não autenticado.", "error");
        return;
      }
      
      const form = e.target;
      const errorEl = document.getElementById('enrollError');
      const submitBtn = form.querySelector('button[type="submit"]');
      const btnText = document.getElementById('enrollSubmitBtnText');
      const spinner = document.getElementById('enrollSpinner');
      
      // Validar checkboxes de consentimento
      const consentImage = document.getElementById('enrollConsentImage').checked;
      const consentLGPD = document.getElementById('enrollConsentLGPD').checked;

      if (!consentImage || !consentLGPD) {
          errorEl.textContent = "É necessário aceitar os termos de uso de imagem e a política de privacidade.";
          errorEl.classList.remove('hidden');
          return;
      }

      // Mostrar spinner
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');

      try {
        const enrollmentData = {
          userId: currentUser.uid, // Guarda o UID do usuário (anônimo ou logado)
          courseId: currentCourseId,
          courseName: document.getElementById('enrollCourseName').textContent,
          name: document.getElementById('enrollName').value,
          email: document.getElementById('enrollEmail').value,
          phone: document.getElementById('enrollPhone').value,
          sector: document.getElementById('enrollSector').value,
          consentImage: consentImage,
          consentLGPD: consentLGPD,
          createdAt: serverTimestamp() // Usa o timestamp do servidor
        };
        
        const docRef = await addDoc(enrollmentsCollection, enrollmentData);
        
        // Gerar protocolo curto (Ex: EVR-A1B2C3)
        const protocol = `EVR-${docRef.id.substring(0, 6).toUpperCase()}`;
        // Atualizar o documento recém-criado com o protocolo
        await updateDoc(docRef, { protocol: protocol });
        
        // Mostrar modal de sucesso
        document.getElementById('enrollProtocol').textContent = protocol;
        _closeModal(modalEnroll);
        _openModal(modalEnrollSuccess);
        
      } catch (error) {
        console.error("Erro ao inscrever:", error);
        errorEl.textContent = `Erro ao processar inscrição: ${error.message}`;
        errorEl.classList.remove('hidden');
        showToast(`Erro ao processar inscrição: ${error.message}`, "error");
      } finally {
        // Esconder spinner
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // Fechar modal de sucesso da inscrição
    document.getElementById('closeEnrollSuccess').addEventListener('click', () => _closeModal(modalEnrollSuccess));
    
    // Abrir Modal de Check-in
    function openCheckinModal(courseId) {
      currentCourseId = courseId;
      document.getElementById('checkinForm').reset();
      document.getElementById('checkinError').classList.add('hidden');
      _openModal(modalCheckin);
    }
    
    // Submeter Check-in
    document.getElementById('checkinForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showToast("Erro: Usuário não autenticado.", "error");
        return;
      }
      
      const password = document.getElementById('checkinPassword').value;
      const errorEl = document.getElementById('checkinError');
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('checkinSubmitBtnText');
      const spinner = document.getElementById('checkinSpinner');

      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      try {
        // Criar o documento de check-in com a senha
        // As Regras do Firestore (v2) vão validar a senha no backend
        const checkinData = {
          userId: currentUser.uid,
          courseId: currentCourseId,
          password: password, // A senha é enviada para validação pelas regras
          createdAt: serverTimestamp()
        };
        
        await addDoc(checkinsCollection, checkinData);
        
        // Sucesso!
        userCheckins[currentCourseId] = true; // Atualiza o cache local
        const course = localCourses.find(c => c.id === currentCourseId);
        if (course) { // Verifica se o curso ainda está carregado
           updateCourseDetailButtons(course); // Atualiza os botões na página de detalhes
        }
        _closeModal(modalCheckin);
        showToast("Check-in realizado com sucesso!", "success");
        
      } catch (error) {
        console.error("Erro no check-in:", error);
        // A mensagem de erro das regras do Firestore geralmente é 'permission-denied'
        if (error.code === 'permission-denied' || error.message.includes("permission-denied")) {
           errorEl.textContent = "Senha incorreta. Tente novamente.";
        } else {
           errorEl.textContent = `Erro: ${error.message}`; // Mostra outros erros
        }
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });
    
    // Abrir Modal de Avaliação
    function openRatingModal(courseId) {
      currentCourseId = courseId;
      const course = localCourses.find(c => c.id === courseId);
      const select = document.getElementById('ratingInstructorSelect');
      select.innerHTML = ''; // Limpa opções anteriores
      // Adiciona instrutores do curso específico
      if (course && course.instructors) {
          course.instructors.forEach(inst => {
            select.innerHTML += `<option value="${inst.name}">${inst.name}</option>`;
          });
      } else {
          select.innerHTML = '<option value="">Nenhum instrutor encontrado</option>';
      }
      document.getElementById('ratingForm').reset();
      document.getElementById('ratingError').classList.add('hidden');
      // Resetar estrelas
      _resetRatingStars();
      document.getElementById('ratingValue').value = "0"; // Garante reset
      _openModal(modalRating);
    }
    
    // Lógica das Estrelas
    const ratingStars = document.getElementById('ratingStars');
    ratingStars.addEventListener('click', (e) => {
      if (e.target.classList.contains('fa-star')) {
        const value = e.target.dataset.value;
        document.getElementById('ratingValue').value = value;
        _updateRatingStars(value);
      }
    });
    function _updateRatingStars(value) {
      const stars = ratingStars.querySelectorAll('.fa-star');
      stars.forEach(star => {
        star.classList.remove('text-yellow-400', 'text-gray-300');
        if (star.dataset.value <= value) {
          star.classList.add('text-yellow-400'); // Preenche
        } else {
          star.classList.add('text-gray-300'); // Vazio
        }
      });
    }
    function _resetRatingStars() { _updateRatingStars(0); }
    
    // Submeter Avaliação
    document.getElementById('ratingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showToast("Erro: Usuário não autenticado.", "error");
        return;
      }
      
      const ratingValue = document.getElementById('ratingValue').value;
      const errorEl = document.getElementById('ratingError');

      // Validar se uma estrela foi selecionada
      if (ratingValue === "0") {
         errorEl.textContent = "Por favor, selecione de 1 a 5 estrelas.";
         errorEl.classList.remove('hidden');
         return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('ratingSubmitBtnText');
      const spinner = document.getElementById('ratingSpinner');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      try {
        const ratingData = {
          userId: currentUser.uid,
          courseId: currentCourseId,
          instructorName: document.getElementById('ratingInstructorSelect').value,
          rating: parseInt(ratingValue),
          comment: document.getElementById('ratingComment').value,
          createdAt: serverTimestamp()
        };
        
        await addDoc(ratingsCollection, ratingData);
        
        _closeModal(modalRating);
        showToast("Avaliação enviada com sucesso! Obrigado.", "success");
        
      } catch (error) {
        console.error("Erro ao enviar avaliação:", error);
        errorEl.textContent = `Erro: ${error.message}`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // Abrir Modal de Verificação de Certificado
    function openCertificateCheckModal(courseId = null) {
      currentCourseId = courseId; // Guarda o ID do curso atual
      document.getElementById('certificateCheckForm').reset();
      document.getElementById('certificateCheckError').classList.add('hidden');
      document.getElementById('certificateCheckResult').innerHTML = ''; // Limpa resultado anterior
      document.getElementById('certificateCheckResult').classList.add('hidden');
      _openModal(modalCertificateCheck);
    }
    
    // Submeter Verificação de Certificado
    document.getElementById('certificateCheckForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('certificateCheckEmail').value;
      const errorEl = document.getElementById('certificateCheckError');
      const resultEl = document.getElementById('certificateCheckResult'); // Elemento para sucesso
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('certificateCheckSubmitBtnText');
      const spinner = document.getElementById('certificateCheckSpinner');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      resultEl.innerHTML = ''; // Limpa resultado
      resultEl.classList.add('hidden');
      
      if (!currentCourseId) {
          errorEl.textContent = "Erro: ID do curso não definido.";
          errorEl.classList.remove('hidden');
          spinner.classList.add('hidden');
          btnText.classList.remove('hidden');
          submitBtn.disabled = false;
          return;
      }
      
      try {
        // Consulta pública permitida pelas regras (v2 do Firestore)
        const q = query(certificatesCollection,
          where("studentEmail", "==", email),
          where("courseId", "==", currentCourseId),
          where("status", "==", "liberado") // Só busca certificados liberados
        );
        
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          errorEl.textContent = "Nenhum certificado liberado foi encontrado para este e-mail e curso. Verifique os dados ou aguarde a liberação.";
          errorEl.classList.remove('hidden');
        } else {
          // Sucesso! Encontrou o certificado.
          const cert = querySnapshot.docs[0].data();
          const certId = querySnapshot.docs[0].id;
          console.log("Certificado encontrado:", certId);

          if (cert.downloadURL) {
            // Se tem URL, mostra o botão de download
            resultEl.innerHTML = `
              <p class="text-green-600 text-sm mb-4">Certificado para <strong>${cert.studentName}</strong> encontrado!</p>
              <a href="${cert.downloadURL}" target="_blank" download="${cert.studentName}-${cert.courseId}.pdf" class="btn-primary w-full !py-3 !text-base !flex !items-center !justify-center">
                <i class="fas fa-download mr-2"></i>Baixar Certificado
              </a>
            `;
          } else {
            // Se está liberado mas não tem URL, informa o usuário
             resultEl.innerHTML = `
              <p class="text-yellow-600 text-sm">
                Certificado para <strong>${cert.studentName}</strong> está liberado, mas o arquivo PDF ainda não foi anexado pelo administrador.
              </p>
            `;
          }
          resultEl.classList.remove('hidden'); // Mostra sucesso
        }
        
      } catch (error) {
        console.error("Erro ao verificar certificado:", error);
        errorEl.textContent = `Erro ao buscar certificado: ${error.message}. Verifique as regras do Firestore.`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });
    
    // Download de Materiais
    function downloadMaterial(courseId) {
      const course = localCourses.find(c => c.id === courseId);
      if (course && course.materials && course.materials.length > 0) {
        // Assume que só há um material por curso por enquanto
        const materialUrl = course.materials[0].url;
        if (materialUrl) {
          window.open(materialUrl, '_blank'); // Abre o URL do Storage em nova aba
        } else {
          showToast("Erro: URL do material não encontrado.", "error");
        }
      } else {
        showToast("Nenhum material disponível para este curso.", "error");
      }
    }


    // === PAINEL DE ADMINISTRAÇÃO ===
    
    let enrollmentsChartInstance = null;
    
    // Carregar dados para o Dashboard
    async function loadAdminDashboardData() {
      if (!isAdmin) return; // Segurança extra
      
      // Carrega Cursos (para senhas) e Matrículas (para gráfico)
      loadAdminCourses(); 
      loadAdminEnrollments(true); // true = carregar dados para o gráfico
      
      // Carrega Check-ins
      try {
        const checkinsSnap = await getDocs(checkinsCollection);
        document.getElementById('stats-total-checkins').textContent = checkinsSnap.size;
      } catch (e) { console.error("Erro ao carregar stats checkins:", e); }
      
      // Carrega Certificados
      try {
        const certsSnap = await getDocs(certificatesCollection);
        document.getElementById('stats-total-certs').textContent = certsSnap.size;
      } catch (e) { console.error("Erro ao carregar stats certificados:", e); }
    }
    
    // Renderizar Gráfico de Matrículas
    function renderEnrollmentsChart(enrollments) {
      const ctx = document.getElementById('enrollmentsChart');
      if (!ctx) return; // Sai se o elemento não existir
      
      // Agrupar matrículas por dia
      const enrollmentsByDay = enrollments.reduce((acc, curr) => {
        // Verifica se createdAt existe e é um timestamp do Firebase
        if (curr.createdAt && typeof curr.createdAt.toDate === 'function') {
           const date = curr.createdAt.toDate().toISOString().split('T')[0]; // Formato YYYY-MM-DD
           acc[date] = (acc[date] || 0) + 1;
        } else {
            // Tenta usar uma data alternativa ou ignora se não houver timestamp válido
            console.warn("Matrícula sem timestamp válido:", curr.id);
        }
        return acc;
      }, {});
      
      const sortedDates = Object.keys(enrollmentsByDay).sort();
      const chartLabels = sortedDates.map(date => {
        const [year, month, day] = date.split('-');
        return `${day}/${month}`; // Formato DD/MM
      });
      const chartData = sortedDates.map(date => enrollmentsByDay[date]);
      
      // Destruir instância anterior do gráfico, se existir
      if (enrollmentsChartInstance) {
        enrollmentsChartInstance.destroy();
      }
      
      enrollmentsChartInstance = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Novas Matrículas',
            data: chartData,
            borderColor: 'rgb(0, 102, 204)',
            backgroundColor: 'rgba(0, 102, 204, 0.1)',
            borderWidth: 2,
            tension: 0.1, // Suaviza a linha
            fill: true, // Preenche a área sob a linha
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // Permite controlar altura
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                 stepSize: 1 // Garante que o eixo Y só mostre inteiros
              }
            }
          },
          plugins: {
            legend: {
              display: false // Esconde a legenda
            }
          }
        }
      });
    }

    // Carregar Cursos (Admin)
    async function loadAdminCourses() {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-courses-table-body');
      tbody.innerHTML = '<tr><td colspan="5">A carregar...</td></tr>';
      
      try {
        const querySnapshot = await getDocs(coursesCollection);
        localCourses = []; // Limpa cache local
        tbody.innerHTML = ''; // Limpa tabela
        
        if (querySnapshot.empty) {
          tbody.innerHTML = '<tr><td colspan="5">Nenhum curso encontrado.</td></tr>';
        } else {
          querySnapshot.forEach((doc) => {
            const course = { id: doc.id, ...doc.data() };
            localCourses.push(course); // Adiciona ao cache
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>
                <div class="font-bold">${course.title}</div>
                <div class="text-xs text-gray-500">${course.id}</div>
              </td>
              <td>
                <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                  course.status === 'aberto' ? 'bg-green-100 text-green-700' :
                  course.status === 'em_breve' ? 'bg-yellow-100 text-yellow-700' :
                  'bg-gray-100 text-gray-700'
                }">${course.status.replace('_', ' ')}</span>
              </td>
              <td class="text-sm">${(course.instructors || []).map(i => i.name).join(', ') || 'N/A'}</td>
              <td class="text-sm">${course.details?.Data || 'TBA'}</td>
              <td class="actions">
                <button class="btn-edit !p-2" data-id="${course.id}" title="Editar"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
                <button class="btn-danger !p-2" data-id="${course.id}" data-doc-name="${course.title}" data-collection="courses" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        
        // Carregar senhas após carregar cursos
        loadCheckinPasswords();
        
      } catch (error) {
         console.error("Erro ao carregar cursos (Admin):", error);
         tbody.innerHTML = `<tr><td colspan="5" class="text-red-500">Erro: ${error.message}</td></tr>`;
      }
    }
    
    // Carregar Matrículas (Admin)
    async function loadAdminEnrollments(forChart = false) {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-enrollments-table-body');
      
      if (!forChart) {
        tbody.innerHTML = '<tr><td colspan="7">A carregar...</td></tr>';
      }
      
      try {
          const querySnapshot = await getDocs(enrollmentsCollection);
          const enrollments = [];
          
          if (!forChart) tbody.innerHTML = ''; // Limpa tabela
          
          if (querySnapshot.empty) {
            if (!forChart) tbody.innerHTML = '<tr><td colspan="7">Nenhuma matrícula encontrada.</td></tr>';
            document.getElementById('stats-total-enrollments').textContent = '0';
            renderEnrollmentsChart([]); // Renderiza gráfico vazio
          } else {
              querySnapshot.forEach((doc) => {
                const enrollment = { id: doc.id, ...doc.data() };
                enrollments.push(enrollment); // Adiciona para o gráfico
                
                if (!forChart) { // Só renderiza na tabela se não for para o gráfico
                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td><div class="font-mono text-xs">${enrollment.protocol || enrollment.id}</div></td>
                    <td>${enrollment.name}</td>
                    <td>${enrollment.email}</td>
                    <td>${enrollment.courseName}</td>
                    <td>${enrollment.createdAt?.toDate ? enrollment.createdAt.toDate().toLocaleDateString('pt-PT') : 'N/A'}</td>
                    <td>${enrollment.sector}</td>
                    <td class="actions">
                      <button class="btn-danger !p-2" data-id="${enrollment.id}" data-doc-name="${enrollment.name} (${enrollment.email})" data-collection="enrollments" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
                    </td>
                  `;
                  tbody.appendChild(tr);
                }
              });
              
              document.getElementById('stats-total-enrollments').textContent = enrollments.length;
              if (forChart) {
                renderEnrollmentsChart(enrollments); // Renderiza o gráfico
              }
          }
      } catch (error) {
          console.error("Erro ao carregar matrículas (Admin):", error);
          if (!forChart) tbody.innerHTML = `<tr><td colspan="7" class="text-red-500">Erro: ${error.message}</td></tr>`;
          document.getElementById('stats-total-enrollments').textContent = 'Erro';
          if (forChart) renderEnrollmentsChart([]); // Gráfico vazio em caso de erro
      }
    }
    
    // Carregar Instrutores (Admin)
    async function loadAdminInstructors() {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-instructors-table-body');
      tbody.innerHTML = '<tr><td colspan="4">A carregar...</td></tr>';
      
      try {
          const querySnapshot = await getDocs(instructorsCollection);
          localInstructors = []; // Limpa cache local
          tbody.innerHTML = ''; // Limpa tabela
          
          if (querySnapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="4">Nenhum instrutor encontrado.</td></tr>';
          } else {
            querySnapshot.forEach((doc) => {
              const inst = { id: doc.id, ...doc.data() };
              localInstructors.push(inst); // Adiciona ao cache
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><img src="${inst.image}" alt="${inst.name}" class="w-12 h-12 rounded-full object-cover"></td>
                <td><div class="font-bold">${inst.name}</div></td>
                <td class="text-sm">${inst.title}</td>
                <td class="actions">
                  <button class="btn-edit !p-2" data-id="${inst.id}" title="Editar"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
                  <button class="btn-danger !p-2" data-id="${inst.id}" data-doc-name="${inst.name}" data-collection="instructors" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }
      } catch (error) {
          console.error("Erro ao carregar instrutores (Admin):", error);
          tbody.innerHTML = `<tr><td colspan="4" class="text-red-500">Erro: ${error.message}</td></tr>`;
      }
    }

    // Carregar Certificados (Admin)
    async function loadAdminCertificates() {
       if (!isAdmin) return;
      const tbody = document.getElementById('admin-certificates-table-body');
      tbody.innerHTML = '<tr><td colspan="7">A carregar...</td></tr>';
      
      try {
          const querySnapshot = await getDocs(certificatesCollection);
          tbody.innerHTML = ''; // Limpa tabela
          
          if (querySnapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="7">Nenhum certificado emitido.</td></tr>';
          } else {
            querySnapshot.forEach((doc) => {
              const cert = { id: doc.id, ...doc.data() };
              const tr = document.createElement('tr');
              const isLiberado = cert.status === 'liberado';
              tr.innerHTML = `
                <td><div class="font-mono text-xs">${cert.id}</div></td>
                <td>${cert.studentName}</td>
                <td>${cert.studentEmail}</td>
                <td>${cert.courseName}</td>
                <td>${cert.issuedAt || 'N/A'}</td>
                <td>
                   <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                    isLiberado ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                  }">${isLiberado ? 'Liberado' : 'Pendente'}</span>
                </td>
                <td class="actions">
                  <button class="btn-edit !p-2" data-id="${cert.id}" title="Editar"><i class="fas fa-pencil-alt pointer-events-none"></i></button>
                  <button class="btn-danger !p-2" data-id="${cert.id}" data-doc-name="${cert.studentName} - ${cert.courseName}" data-collection="certificates" title="Excluir"><i class="fas fa-trash pointer-events-none"></i></button>
                  ${!isLiberado ? `<button class="btn-primary !p-2 !text-xs !bg-teal-500 hover:!bg-teal-600" data-id="${cert.id}" data-action="release" title="Liberar"><i class="fas fa-check pointer-events-none"></i> Liberar</button>` : ''}
                </td>
              `;
              tbody.appendChild(tr);
            });
          }
      } catch (error) {
           console.error("Erro ao carregar certificados (Admin):", error);
           tbody.innerHTML = `<tr><td colspan="7" class="text-red-500">Erro: ${error.message}</td></tr>`;
      }
    }
    
    // Carregar Senhas de Check-in (Admin)
    async function loadCheckinPasswords() {
       if (!isAdmin) return;
      const form = document.getElementById('checkin-passwords-form');
      form.innerHTML = ''; // Limpa antes de adicionar
      
      try {
          // Garante que os cursos estejam carregados no cache
          if (localCourses.length === 0) {
              await loadAdminCourses(); // Tenta carregar se estiver vazio
          }
          
          // Busca o documento único que guarda todas as senhas
          const passwordsDocRef = doc(db, `artifacts/${appId}/public/data/checkinPasswords`, 'allCourses');
          const docSnap = await getDoc(passwordsDocRef);
          const passwords = docSnap.exists() ? docSnap.data() : {}; // Pega o objeto de senhas
          
          if (localCourses.length === 0) {
              form.innerHTML = '<p class="text-sm text-gray-500">Nenhum curso cadastrado para definir senhas.</p>';
              return;
          }
          
          // Cria um input para cada curso no cache
          localCourses.forEach(course => {
            const div = document.createElement('div');
            div.innerHTML = `
              <label class="admin-label" for="pass-${course.id}">${course.title}</label>
              <input type="text" id="pass-${course.id}" data-courseid="${course.id}" class="admin-input" value="${passwords[course.id] || ''}" placeholder="Senha para ${course.title}">
            `;
            form.appendChild(div);
          });
      } catch(error) {
           console.error("Erro ao carregar senhas de check-in:", error);
           form.innerHTML = `<p class="text-sm text-red-500">Erro ao carregar senhas: ${error.message}</p>`;
      }
    }
    
    // Salvar Senhas de Check-in
    document.getElementById('save-checkin-passwords-btn').addEventListener('click', async () => {
      const passwords = {};
      const inputs = document.getElementById('checkin-passwords-form').querySelectorAll('input[data-courseid]');
      inputs.forEach(input => {
        if (input.value.trim()) { // Só salva se não estiver vazio
          passwords[input.dataset.courseid] = input.value.trim();
        }
      });
      
      try {
        const passwordsDocRef = doc(db, `artifacts/${appId}/public/data/checkinPasswords`, 'allCourses');
        // Usar setDoc com merge: false substitui o documento inteiro
        await setDoc(passwordsDocRef, passwords); 
        showToast("Senhas de check-in salvas com sucesso!", "success");
      } catch (error) {
        console.error("Erro ao salvar senhas:", error);
        showToast(`Erro ao salvar senhas: ${error.message}`, "error");
      }
    });

    // === GESTÃO DE FORMULÁRIOS ADMIN (CRUD) ===

    // --- CURSOS ---
    document.getElementById('admin-add-course-btn').addEventListener('click', () => openCourseModal());
    
    function openCourseModal(course = null) {
      const form = document.getElementById('courseForm');
      form.reset();
      document.getElementById('courseFormError').classList.add('hidden');
      document.getElementById('courseMaterialCurrent').textContent = '';
      
      const modalTitle = document.getElementById('modalCourseTitle');
      const courseIdField = document.getElementById('courseId');
      
      if (course) {
        // Editar
        modalTitle.textContent = "Editar Curso";
        courseIdField.value = course.id;
        document.getElementById('courseTitle').value = course.title || '';
        document.getElementById('courseSubtitle').value = course.subtitle || '';
        document.getElementById('courseThemeColor').value = course.themeColor || '';
        document.getElementById('courseIcon').value = course.icon || '';
        document.getElementById('courseStatus').value = course.status || 'fechado';
        document.getElementById('courseHeaderImage').value = course.headerOverlayImage || '';
        document.getElementById('courseSummary').value = course.summary || '';
        document.getElementById('courseFullDescription').value = course.fullDescription || '';
        document.getElementById('courseTargetAudience').value = course.targetAudience || '';
        
        // Campos JSON (com formatação bonita)
        try {
          document.getElementById('courseDetails').value = JSON.stringify(course.details || {}, null, 2);
          document.getElementById('courseLearningObjectives').value = JSON.stringify(course.learningObjectives || [], null, 2);
          document.getElementById('courseRequirements').value = JSON.stringify(course.requirements || [], null, 2);
          document.getElementById('courseModules').value = JSON.stringify(course.modules || [], null, 2);
          document.getElementById('coursePracticalActivities').value = JSON.stringify(course.practicalActivities || [], null, 2);
        } catch (e) { 
            console.warn("Erro ao formatar JSON para edição:", e); 
            // Usa fallback vazio se falhar, mas loga o erro
            document.getElementById('courseDetails').value = '{}';
            document.getElementById('courseLearningObjectives').value = '[]';
            document.getElementById('courseRequirements').value = '[]';
            document.getElementById('courseModules').value = '[]';
            document.getElementById('coursePracticalActivities').value = '[]';
        }
        
        if (course.materials && course.materials.length > 0) {
           document.getElementById('courseMaterialCurrent').textContent = `Arquivo atual: ${course.materials[0].name}`;
        }

      } else {
        // Adicionar Novo
        modalTitle.textContent = "Adicionar Novo Curso";
        courseIdField.value = '';
        // Preencher JSONs vazios para facilitar
        document.getElementById('courseDetails').value = '{\n  "Data": "TBA",\n  "Carga": "4h"\n}';
        document.getElementById('courseLearningObjectives').value = '[\n  "Objetivo 1",\n  "Objetivo 2"\n]';
        document.getElementById('courseRequirements').value = '[\n  "Requisito 1"\n]';
        document.getElementById('courseModules').value = '[\n  {\n    "title": "Módulo 1",\n    "topics": [\n      "Tópico 1.1",\n      "Tópico 1.2"\n    ]\n  }\n]';
        document.getElementById('coursePracticalActivities').value = '[\n  {\n    "title": "Atividade Prática 1",\n    "description": "Descrição da atividade."\n  }\n]';
      }
      
      // Popular checkboxes de instrutores (usa cache local 'localInstructors')
      const instList = document.getElementById('courseInstructorsList');
      instList.innerHTML = ''; // Limpa
      const courseInstructorNames = (course?.instructors || []).map(i => i.name);
      
      if (localInstructors.length === 0) {
          instList.innerHTML = '<p class="text-sm text-gray-500">Nenhum instrutor cadastrado. Adicione instrutores primeiro.</p>';
      } else {
          localInstructors.forEach(inst => {
            const checked = courseInstructorNames.includes(inst.name) ? 'checked' : '';
            instList.innerHTML += `
              <label>
                <input type="checkbox" value="${inst.id}" data-name="${inst.name}" data-title="${inst.title}" data-image="${inst.image}" ${checked}>
                ${inst.name} (${inst.title})
              </label>
            `;
          });
      }
      
      _openModal(modalEditCourse);
    }
    
    document.getElementById('courseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('courseSubmitBtnText');
      const spinner = document.getElementById('courseFormSpinner');
      const errorEl = document.getElementById('courseFormError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      const courseId = document.getElementById('courseId').value;
      const fileInput = document.getElementById('courseMaterialFile');
      const file = fileInput.files[0];
      let materialDataArray = []; // Agora é um array

      // Recupera material existente se estiver editando e não houver novo upload
      const existingCourse = courseId ? localCourses.find(c => c.id === courseId) : null;
      if (existingCourse && existingCourse.materials && !file) {
          materialDataArray = existingCourse.materials;
      }

      try {
        // --- 1. Validar JSON e Coletar Dados ---
        let courseData;
        try {
          // Selecionar instrutores marcados e pegar seus dados
          const selectedInstructors = Array.from(document.getElementById('courseInstructorsList').querySelectorAll('input:checked'))
            .map(input => ({ 
                // Pega os dados dos atributos data-* para não depender do cache global
                name: input.dataset.name, 
                title: input.dataset.title, 
                image: input.dataset.image 
            }));
            
          courseData = {
            title: document.getElementById('courseTitle').value,
            subtitle: document.getElementById('courseSubtitle').value,
            themeColor: document.getElementById('courseThemeColor').value,
            icon: document.getElementById('courseIcon').value,
            status: document.getElementById('courseStatus').value,
            headerOverlayImage: document.getElementById('courseHeaderImage').value,
            summary: document.getElementById('courseSummary').value,
            fullDescription: document.getElementById('courseFullDescription').value,
            targetAudience: document.getElementById('courseTargetAudience').value,
            // Parsear campos JSON
            details: JSON.parse(document.getElementById('courseDetails').value),
            learningObjectives: JSON.parse(document.getElementById('courseLearningObjectives').value),
            requirements: JSON.parse(document.getElementById('courseRequirements').value),
            modules: JSON.parse(document.getElementById('courseModules').value),
            practicalActivities: JSON.parse(document.getElementById('coursePracticalActivities').value),
            // Adicionar instrutores selecionados
            instructors: selectedInstructors
            // 'materials' será adicionado após o upload
          };
        } catch (jsonError) {
          throw new Error(`Erro de Formato: O formato JSON em um dos campos (Módulos, Requisitos, etc) está inválido. Verifique vírgulas, aspas e colchetes. Detalhe: ${jsonError.message}`);
        }
        
        // --- 2. Fazer Upload do Material (se houver) ---
        // Gera um ID ÚNICO se for um curso novo, ou usa o existente
        const finalCourseId = courseId || doc(collection(db, 'temp')).id; 
        
        if (file) {
          try {
            // TODO: Excluir arquivo antigo do Storage se estiver substituindo
            const storageRef = ref(storage, `materials/${finalCourseId}/${file.name}`);
            console.log("A enviar material para:", storageRef.fullPath);
            const snapshot = await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(snapshot.ref);
            // Cria o objeto de material e coloca num array
            materialDataArray = [{
              name: file.name,
              url: downloadURL,
              path: snapshot.ref.fullPath // Guarda o caminho para futura exclusão, se necessário
            }];
            console.log("Upload bem-sucedido:", downloadURL);
          } catch (uploadError) {
             console.error("Erro no upload:", uploadError);
             throw new Error(`Erro de Upload: Não foi possível enviar o material. Verifique as regras do Storage e o tamanho do arquivo. Detalhe: ${uploadError.code || uploadError.message}`);
          }
        }
        
        // Adiciona o array de materiais (novo ou existente) aos dados do curso
        courseData.materials = materialDataArray;

        // --- 3. Salvar no Firestore ---
        try {
          let courseRef;
          if (courseId) {
            // Atualizar Documento Existente
            courseRef = doc(db, `artifacts/${appId}/public/data/courses`, courseId);
            await updateDoc(courseRef, courseData);
            console.log("Curso atualizado:", courseId);
          } else {
            // Criar Novo Documento (usando o ID gerado 'finalCourseId')
            courseRef = doc(db, `artifacts/${appId}/public/data/courses`, finalCourseId);
            await setDoc(courseRef, courseData);
            console.log("Novo curso criado:", finalCourseId);
          }
        } catch (saveError) {
          console.error("Erro ao salvar no Firestore:", saveError);
          throw new Error(`Erro ao Salvar: Não foi possível salvar no banco de dados. Verifique as regras do Firestore. Detalhe: ${saveError.message}`);
        }
        
        showToast("Curso salvo com sucesso!", "success");
        _closeModal(modalEditCourse);
        loadAdminCourses(); // Recarrega tabela de cursos no admin
        loadCourses(); // Recarrega lista pública de cursos
        
      } catch (error) {
        // Mostra o erro específico que foi lançado
        console.error("Erro geral ao salvar curso:", error);
        errorEl.textContent = error.message; 
        errorEl.classList.remove('hidden');
      } finally {
        // Sempre reabilita o botão e esconde o spinner
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
        fileInput.value = ''; // Limpa o input de arquivo para evitar reenvio acidental
      }
    });

    // --- INSTRUTORES ---
    document.getElementById('admin-add-instructor-btn').addEventListener('click', () => openInstructorModal());

    function openInstructorModal(instructor = null) {
      const form = document.getElementById('instructorForm');
      form.reset();
      document.getElementById('instructorFormError').classList.add('hidden');
      
      const modalTitle = document.getElementById('modalInstructorTitle');
      const instructorIdField = document.getElementById('instructorId');
      
      if (instructor) {
        // Editar
        modalTitle.textContent = "Editar Instrutor";
        instructorIdField.value = instructor.id;
        document.getElementById('instructorName').value = instructor.name || '';
        document.getElementById('instructorTitle').value = instructor.title || '';
        document.getElementById('instructorImage').value = instructor.image || '';
        document.getElementById('instructorBio').value = instructor.bio || '';
      } else {
        // Adicionar Novo
        modalTitle.textContent = "Adicionar Novo Instrutor";
        instructorIdField.value = '';
      }
      _openModal(modalEditInstructor);
    }
    
    document.getElementById('instructorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('instructorSubmitBtnText');
      const spinner = document.getElementById('instructorFormSpinner');
      const errorEl = document.getElementById('instructorFormError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      const instructorId = document.getElementById('instructorId').value;
      const instructorData = {
        name: document.getElementById('instructorName').value,
        title: document.getElementById('instructorTitle').value,
        image: document.getElementById('instructorImage').value,
        bio: document.getElementById('instructorBio').value
      };
      
      try {
        let instRef;
        if (instructorId) {
          // Atualizar
          instRef = doc(db, `artifacts/${appId}/public/data/instructors`, instructorId);
          await updateDoc(instRef, instructorData);
        } else {
          // Criar Novo
          instRef = await addDoc(instructorsCollection, instructorData);
        }
        
        showToast("Instrutor salvo com sucesso!", "success");
        _closeModal(modalEditInstructor);
        loadAdminInstructors(); // Recarrega tabela admin
        loadInstructors(); // Recarrega cache local (usado no modal de curso)
        
      } catch (error) {
        console.error("Erro ao salvar instrutor:", error);
        errorEl.textContent = `Erro: ${error.message}`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
      }
    });

    // --- CERTIFICADOS ---
    document.getElementById('admin-add-certificate-btn').addEventListener('click', () => openCertificateModal());
    
    function openCertificateModal(cert = null) {
      const form = document.getElementById('certificateForm');
      form.reset();
      document.getElementById('certificateFormError').classList.add('hidden');
      document.getElementById('certificateFile').value = ''; // Limpa input de arquivo
      const currentFileEl = document.getElementById('certificateCurrentFile');
      currentFileEl.textContent = '';
      
      const modalTitle = document.getElementById('modalCertificateTitle');
      const certificateIdField = document.getElementById('certificateId');
      
      if (cert) {
        // Editar
        modalTitle.textContent = "Editar Certificado";
        certificateIdField.value = cert.id;
        document.getElementById('certificateStudentName').value = cert.studentName || '';
        document.getElementById('certificateStudentEmail').value = cert.studentEmail || '';
        document.getElementById('certificateStudentId').value = cert.studentId || '';
        document.getElementById('certificateCourseName').value = cert.courseName || '';
        document.getElementById('certificateCourseId').value = cert.courseId || '';
        document.getElementById('certificateIssuedAt').value = cert.issuedAt || '';
        
        // Mostrar arquivo atual
        if (cert.storagePath) {
            // Extrai o nome do arquivo do storagePath
            const fileName = cert.storagePath.split('/').pop();
            currentFileEl.textContent = `Arquivo atual: ${fileName}`;
        } else if (cert.downloadURL) {
             currentFileEl.textContent = `Arquivo atual: (Link externo)`;
        } else {
             currentFileEl.textContent = 'Nenhum PDF anexado.';
        }
        
      } else {
        // Adicionar Novo (Emitir)
        modalTitle.textContent = "Emitir Novo Certificado";
        certificateIdField.value = '';
        // Preencher data atual
        document.getElementById('certificateIssuedAt').value = new Date().toISOString().split('T')[0];
        currentFileEl.textContent = 'Nenhum PDF anexado.';
      }
      _openModal(modalEditCertificate);
    }
    
    document.getElementById('certificateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const btnText = document.getElementById('certificateSubmitBtnText');
      const spinner = document.getElementById('certificateFormSpinner');
      const errorEl = document.getElementById('certificateFormError');
      
      btnText.classList.add('hidden');
      spinner.classList.remove('hidden');
      submitBtn.disabled = true;
      errorEl.classList.add('hidden');
      
      const certificateId = document.getElementById('certificateId').value;
      const fileInput = document.getElementById('certificateFile');
      const file = fileInput.files[0];
      
      // Gera um ID ÚNICO se for um novo certificado, ou usa o existente
      const finalCertificateId = certificateId || doc(collection(db, 'temp')).id;
      
      const studentEmail = document.getElementById('certificateStudentEmail').value;
      const courseId = document.getElementById('certificateCourseId').value;
      
      // Dados base do certificado
      let certificateData = {
        studentName: document.getElementById('certificateStudentName').value,
        studentEmail: studentEmail,
        studentId: document.getElementById('certificateStudentId').value || null, // Guarda null se vazio
        courseName: document.getElementById('certificateCourseName').value,
        courseId: courseId,
        issuedAt: document.getElementById('certificateIssuedAt').value,
        // 'status', 'downloadURL', 'storagePath' serão definidos abaixo
      };
      
      try {
        let certRef;
        let existingData = { status: 'pendente' }; // Default para novo

        if (certificateId) {
            // Se estiver editando, busca os dados existentes
            certRef = doc(db, `artifacts/${appId}/public/data/certificates`, certificateId);
            const docSnap = await getDoc(certRef);
            if (docSnap.exists()) {
                existingData = docSnap.data();
            }
        } else {
            // Se for novo, usa o ID gerado
            certRef = doc(db, `artifacts/${appId}/public/data/certificates`, finalCertificateId);
        }

        // Mantém o status original (se já era 'liberado', continua 'liberado')
        certificateData.status = existingData.status || 'pendente';
        // Mantém os dados do arquivo antigo, a menos que um novo seja enviado
        certificateData.downloadURL = existingData.downloadURL || null;
        certificateData.storagePath = existingData.storagePath || null;
        
        // --- Upload do PDF (se houver) ---
        if (file) {
          // TODO: Excluir PDF antigo do Storage se existir (usando existingData.storagePath)
          if (existingData.storagePath) {
             try {
                const oldFileRef = ref(storage, existingData.storagePath);
                await deleteObject(oldFileRef);
                console.log("Arquivo antigo do certificado excluído:", existingData.storagePath);
             } catch (deleteError) {
                // Não impede o novo upload, mas avisa
                console.warn("Erro ao excluir PDF antigo do certificado:", deleteError); 
             }
          }
        
          // Define um caminho único e padronizado
          const storagePath = `certificates/${courseId}/${finalCertificateId}_${studentEmail}.pdf`;
          const storageRef = ref(storage, storagePath);
          
          console.log("A enviar PDF do certificado para:", storageRef.fullPath);
          const snapshot = await uploadBytes(storageRef, file);
          const downloadURL = await getDownloadURL(snapshot.ref);
          
          // Atualiza os dados do certificado com as novas URLs
          certificateData.downloadURL = downloadURL;
          certificateData.storagePath = snapshot.ref.fullPath;
          console.log("Upload de PDF bem-sucedido:", downloadURL);
        }
        
        // --- Salvar no Firestore ---
        if (certificateId) {
          // Atualizar
          await updateDoc(certRef, certificateData);
        } else {
          // Criar Novo
          await setDoc(certRef, certificateData); // Use setDoc com o ID gerado
        }
        
        showToast("Certificado salvo com sucesso!", "success");
        _closeModal(modalEditCertificate);
        loadAdminCertificates(); // Recarrega tabela
        
      } catch (error) {
        console.error("Erro ao salvar certificado:", error);
        errorEl.textContent = `Erro: ${error.message}`;
        errorEl.classList.remove('hidden');
      } finally {
        btnText.classList.remove('hidden');
        spinner.classList.add('hidden');
        submitBtn.disabled = false;
        fileInput.value = ''; // Limpa o input de arquivo
      }
    });
    
    // Liberar Certificado
    async function releaseCertificate(id) {
      // Como não podemos usar 'confirm', a ação é direta.
      // O usuário terá que clicar no botão 'Liberar'
      
      try {
        const certRef = doc(db, `artifacts/${appId}/public/data/certificates`, id);
        await updateDoc(certRef, { status: 'liberado' });
        showToast("Certificado liberado com sucesso!", "success");
        loadAdminCertificates(); // Recarrega a tabela para mostrar o novo status
      } catch (error) {
        console.error("Erro ao liberar certificado:", error);
        showToast(`Erro ao liberar: ${error.message}`, "error");
      }
    }
    
    // === GESTÃO DE CLIQUES (Event Delegation) ===
    
    // Cliques na Página Principal
    document.getElementById('main-view').addEventListener('click', (e) => {
      // Abrir Modal de Admin (se não for admin) ou ir para painel (se for admin)
      if (e.target.closest('#adminBtnHeader') || e.target.closest('#adminBtnFooter')) {
        // Ação já é tratada pelo `setAdminUI`
      }
      
      // Abrir detalhes do curso
      const card = e.target.closest('[data-course-id]');
      if (card) {
        const courseId = card.dataset.courseId;
        const course = localCourses.find(c => c.id === courseId);
        if (course) {
            renderCourseDetail(course);
        } else {
            showToast("Erro: Curso não encontrado localmente.", "error");
        }
      }
    });

    // Cliques na Página de Detalhes
    courseDetailView.addEventListener('click', (e) => {
      // A função precisa encontrar o curso atual ANTES de agir
      const course = localCourses.find(c => c.id === currentCourseId); 
      if (!course) {
        // Se o curso não for encontrado (pode acontecer em um reload da página de detalhes)
        // Tenta voltar
        if (e.target.closest('#back-to-courses-btn')) {
          showView('main');
        }
        // Não continua se o curso não estiver no cache
        return; 
      }
      
      // Voltar para la lista principal
      if (e.target.closest('#back-to-courses-btn')) {
        showView('main');
      }
      // Abrir modal de inscrição
      if (e.target.closest('#enroll-btn-detail')) {
        openEnrollModal(course.id, course.title);
      }
      // Abrir modal de check-in (se o botão não estiver desabilitado)
      if (e.target.closest('#checkin-btn-detail') && !e.target.closest('.btn-disabled')) {
        openCheckinModal(course.id);
      }
      // Baixar materiais (se o botão não estiver desabilitado)
      if (e.target.closest('#materials-btn-detail') && !e.target.closest('.btn-disabled')) {
        downloadMaterial(course.id);
      }
      // Abrir modal de avaliação (se o botão não estiver desabilitado)
      if (e.target.closest('#rating-btn-detail') && !e.target.closest('.btn-disabled')) {
        openRatingModal(course.id);
      }
      // Abrir modal de verificação de certificado
      if (e.target.closest('#certificate-btn-detail')) {
        openCertificateCheckModal(course.id);
      }
    });
    
    // Função Genérica de Exclusão (Admin)
    async function handleDeleteDoc(collectionName, docId, docName, reloadFunction) {
      // AVISO: Sem 'confirm()', a exclusão é imediata.
      // Em um app real, usaríamos um modal de confirmação customizado.
      console.log(`A excluir ${collectionName} ID: ${docId} (Nome: ${docName})`);
      
      try {
        let collectionRef;
        // Mapeia o nome da coleção para a referência correta
        switch(collectionName) {
            case 'courses': collectionRef = coursesCollection; break;
            case 'instructors': collectionRef = instructorsCollection; break;
            case 'enrollments': collectionRef = enrollmentsCollection; break;
            case 'certificates': collectionRef = certificatesCollection; break;
            default: throw new Error("Coleção desconhecida");
        }
        
        const docRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, docId);
        
        // Lógica de limpeza (Ex: excluir arquivos do Storage)
        if (collectionName === 'courses' || collectionName === 'certificates') {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                let pathToDelete = null;
                
                if (collectionName === 'courses' && data.materials && data.materials.length > 0) {
                    pathToDelete = data.materials[0].path; // Pega o caminho do material
                } else if (collectionName === 'certificates' && data.storagePath) {
                    pathToDelete = data.storagePath; // Pega o caminho do PDF
                }
                
                if (pathToDelete) {
                    try {
                        const fileRef = ref(storage, pathToDelete);
                        await deleteObject(fileRef);
                        console.log(`Arquivo do Storage excluído: ${pathToDelete}`);
                    } catch (storageError) {
                        console.warn(`Erro ao excluir arquivo do Storage (${pathToDelete}): ${storageError.code}. O documento será excluído mesmo assim.`);
                    }
                }
            }
        }
        
        // Excluir o documento do Firestore
        await deleteDoc(docRef);
        showToast(`${docName} excluído com sucesso.`, "success");
        
        // Recarregar a tabela correspondente
        if (reloadFunction) reloadFunction();
        
        // Recarregar dados públicos se Cursos ou Instrutores forem alterados
        if (collectionName === 'courses') loadCourses();
        if (collectionName === 'instructors') loadInstructors();
        
      } catch (error) {
        console.error(`Erro ao excluir ${collectionName} (ID: ${docId}):`, error);
        showToast(`Erro ao excluir: ${error.message}`, "error");
      }
    }
    
    // Cliques no Painel de Admin
    adminPanelView.addEventListener('click', async (e) => {
      // Navegação entre abas
      const navLink = e.target.closest('.admin-nav-link[data-target]');
      if (navLink) {
        e.preventDefault();
        const targetId = navLink.dataset.target;
        
        // Atualiza UI da navegação
        document.querySelectorAll('.admin-nav-link').forEach(link => link.classList.remove('active'));
        navLink.classList.add('active');
        document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
        const targetSection = document.getElementById(targetId);
        if (targetSection) targetSection.classList.remove('hidden');
        
        // Carrega dados específicos da aba clicada
        switch(targetId) {
          case 'admin-dashboard': loadAdminDashboardData(); break;
          case 'admin-cursos': loadAdminCourses(); break;
          case 'admin-matriculas': loadAdminEnrollments(); break;
          case 'admin-instrutores': loadAdminInstructors(); break;
          case 'admin-certificados': loadAdminCertificates(); break;
          case 'admin-config': loadCheckinPasswords(); break;
        }
      }
      
      // Botão Editar Curso
      const courseEditBtn = e.target.closest('#admin-cursos .btn-edit');
      if (courseEditBtn) {
        const courseId = courseEditBtn.dataset.id;
        const course = localCourses.find(c => c.id === courseId);
        if (course) openCourseModal(course);
      }
      
      // Botão Editar Instrutor
      const instEditBtn = e.target.closest('#admin-instrutores .btn-edit');
      if (instEditBtn) {
         const instructorId = instEditBtn.dataset.id;
         // Usa o cache local que é carregado ao entrar na aba
         const instructor = localInstructors.find(i => i.id === instructorId);
         if (instructor) openInstructorModal(instructor);
      }

      // Botão Editar Certificado
      const certEditBtn = e.target.closest('#admin-certificados .btn-edit');
      if (certEditBtn) {
         const certId = certEditBtn.dataset.id;
         // Precisa buscar o certificado específico do DB para editar
         try {
           const certRef = doc(db, `artifacts/${appId}/public/data/certificates`, certId);
           const certSnap = await getDoc(certRef);
           if (certSnap.exists()) {
             openCertificateModal({ id: certSnap.id, ...certSnap.data() });
           } else {
             showToast("Certificado não encontrado para edição.", "error");
           }
         } catch(error) {
           showToast(`Erro ao buscar certificado: ${error.message}`, "error");
         }
      }
      
      // Botão Liberar Certificado
      const certReleaseBtn = e.target.closest('#admin-certificados [data-action="release"]');
      if (certReleaseBtn) {
        releaseCertificate(certReleaseBtn.dataset.id);
      }
      
      // --- LÓGICA DE EXCLUSÃO (Botões de Lixeira) ---
      const deleteBtn = e.target.closest('.btn-danger[data-collection]');
      if (deleteBtn) {
          const docId = deleteBtn.dataset.id;
          const collectionName = deleteBtn.dataset.collection;
          const docName = deleteBtn.dataset.docName || `ID ${docId}`; // Nome para o toast
          
          let reloadFunc;
          switch(collectionName) {
              case 'courses': reloadFunc = loadAdminCourses; break;
              case 'instructors': reloadFunc = loadAdminInstructors; break;
              case 'enrollments': reloadFunc = loadAdminEnrollments; break;
              case 'certificates': reloadFunc = loadAdminCertificates; break;
          }
          
          // Chama a função genérica de exclusão
          // ATENÇÃO: A exclusão é IMEDIATA sem 'confirm()'
          handleDeleteDoc(collectionName, docId, docName, reloadFunc);
      }
      
    });


    // === FUNÇÕES DE INICIALIZAÇÃO E HELPERS ===
    
    // Fechar Modais (Genérico)
    function _openModal(modalEl) {
      if(modalEl) modalEl.classList.add('show');
    }
    function _closeModal(modalEl) {
       if(modalEl) modalEl.classList.remove('show');
    }
    document.querySelectorAll('.modal-backdrop').forEach(modal => {
      // Fechar no clique do fundo
      modal.addEventListener('click', (e) => {
        if (e.target === modal) _closeModal(modal);
      });
    });
    // Botões de fechar específicos
    document.getElementById('closeLogin')?.addEventListener('click', () => _closeModal(modalLogin));
    document.getElementById('closeEnroll')?.addEventListener('click', () => _closeModal(modalEnroll));
    document.getElementById('closeCheckin')?.addEventListener('click', () => _closeModal(modalCheckin));
    document.getElementById('closeRating')?.addEventListener('click', () => _closeModal(modalRating));
    document.getElementById('closeCertificateCheck')?.addEventListener('click', () => _closeModal(modalCertificateCheck));
    document.getElementById('closeEditCourse')?.addEventListener('click', () => _closeModal(modalEditCourse));
    document.getElementById('courseFormCancel')?.addEventListener('click', () => _closeModal(modalEditCourse));
    document.getElementById('closeEditInstructor')?.addEventListener('click', () => _closeModal(modalEditInstructor));
    document.getElementById('instructorFormCancel')?.addEventListener('click', () => _closeModal(modalEditInstructor));
    document.getElementById('closeEditCertificate')?.addEventListener('click', () => _closeModal(modalEditCertificate));
    document.getElementById('certificateFormCancel')?.addEventListener('click', () => _closeModal(modalEditCertificate));

    
    // Animação de Scroll (Reveal)
    function _setupRevealAnimations() {
      // Desconectar observador anterior se existir
      if (window.revealObserver) {
        window.revealObserver.disconnect();
      }
      // Criar novo observador
      window.revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            e.target.classList.add('show');
            window.revealObserver.unobserve(e.target); // Opcional: parar de observar após revelar
          }
        });
      }, { threshold: 0.1 }); // Começa a revelar quando 10% está visível
      
      // Observar todos os elementos .reveal
      document.querySelectorAll('.reveal').forEach(el => {
          el.classList.remove('show'); // Garante que começa escondido
          window.revealObserver.observe(el);
      });
    }

    // Scroll Progress Bar
    const scrollProgress = document.getElementById('scroll-progress');
    window.addEventListener('scroll', () => {
      const h = document.documentElement;
      const st = h.scrollTop || document.body.scrollTop;
      const sh = h.scrollHeight || document.body.scrollHeight;
      // Previne divisão por zero se o conteúdo for menor que a viewport
      const percent = (sh - h.clientHeight) > 0 ? (st / (sh - h.clientHeight)) * 100 : 0;
      if (scrollProgress) scrollProgress.style.width = percent + '%';
    });

    // Header Efeito Scroll
    const header = document.getElementById('header');
    window.addEventListener('scroll', () => {
      if (header) { // Verifica se o header existe
        if (window.scrollY > 10) header.classList.add('header-scrolled');
        else header.classList.remove('header-scrolled');
      }
    });

    // Animação de Partículas no Hero
    const particles = document.getElementById('particles');
    if (particles) {
      const createParticle = () => {
        const s = document.createElement('span');
        s.style.left = Math.random() * 100 + 'vw';
        s.style.bottom = '-10px'; // Começa abaixo da tela
        s.style.width = (Math.random() * 2 + 1) + 'px'; // Tamanho aleatório
        s.style.height = s.style.width;
        s.style.animationDuration = (Math.random() * 8 + 6) + 's'; // Duração aleatória (6-14s)
        s.style.animationDelay = Math.random() * 5 + 's'; // Atraso aleatório (0-5s)
        particles.appendChild(s);
        // Remove a partícula da DOM após a animação + um buffer
        setTimeout(() => s.remove(), parseFloat(s.style.animationDuration) * 1000 + parseFloat(s.style.animationDelay) * 1000 + 1000);
      };
      // Criar partículas iniciais
      for (let i = 0; i < 60; i++) createParticle();
      // Criar novas partículas periodicamente
      setInterval(createParticle, 600); // Cria uma nova a cada 600ms
    }
    
    // Navegação pelo Logo
    document.getElementById('logo-link')?.addEventListener('click', (e) => {
      e.preventDefault();
      showView('main');
    });
    
    // --- POPULAR DADOS INICIAIS (Admin Config) ---
    document.getElementById('populate-db-btn').addEventListener('click', async () => {
      if (!isAdmin) { showToast("Apenas administradores.", "error"); return; }
      // ATENÇÃO: Removido o 'confirm()' para seguir as regras. A ação é imediata.
      showToast("A popular o banco de dados... (Ação imediata)", "success");
      
      const batch = writeBatch(db);
      
      // Dados dos Instrutores
      const instructorsData = [
        { id: "marllon", name: "Marllon Costa", title: "Téc. TI | Designer | Mkt | IA", image: "https://i.postimg.cc/sxm4TVvF/IMG-9781.jpg", bio: "Designer gráfico, graduando em marketing e autodidata em Inovação e IA..." },
        { id: "vinicius", name: "Vinícius Sena", title: "Fotógrafo | Animação | Pós-produção", image: "https://i.postimg.cc/bw7kHG3D/vinicius.jpg", bio: "Formado em Animação, estudante e entusiasta de fotografia desde 2019..." },
        { id: "bruno", name: "Bruno Diogo", title: "Sup. Mkt | Designer | UX/UI | Fotografia", image: "https://i.postimg.cc/yNhgmLJK/IMG-7311.avif", bio: "" },
        { id: "keven", name: "Keven Menezes", title: "Analista TI | Designer | Motion Design", image: "https://i.postimg.cc/fTgkcmpP/Whats-App-Image-2025-10-27-at-12-11-25.jpg", bio: "Formado em Design Gráfico, +5 anos de experiência..." },
        { id: "deyse", name: "Deyse Pereira", title: "Comunicação | Design | Gestão Projetos", image: "https://i.postimg.cc/T1sL3bXz/IMG-7381-jpg.png", bio: "Mestre em Design de Artefatos Digitais, pós-graduanda em Gestão de Projetos..." }
      ];
      
      instructorsData.forEach(inst => {
        const ref = doc(db, `artifacts/${appId}/public/data/instructors`, inst.id);
        batch.set(ref, inst);
      });
      
      // Dados dos Cursos (Abertos e Em Breve)
      const coursesData = [
          // Abertos
          { id: "fotografia", status: "aberto", themeColor: "#FFC107", 
            title: "Workshop de Fotografia", subtitle: "O Olhar que Conecta Histórias", icon:"fa-camera-retro", headerOverlayImage:"https://i.postimg.cc/3rLTy2xn/medium-shot-people-with-camera.jpg", 
            summary:"Aprenda a capturar a essência dos nossos projetos com sensibilidade e técnica. Este workshop oferece as ferramentas para transformar o registo de atividades institucionais.", 
            fullDescription:"No Instituto Evereste, cada imagem conta uma parte da nossa história. Este workshop é um convite para desenvolver a sua percepção e criatividade, capacitando-o a registar os nossos eventos e projetos com a qualidade e profissionalismo que eles merecem. Mais do que técnica, aprenderá a contar histórias que conectam e inspiram através das suas lentes.", 
            learningObjectives:[
                "Introduzir conceitos básicos de fotografia (composição, iluminação, enquadramento).",
                "Desenvolver habilidades práticas em fotografia com câmaras e celulares.",
                "Capacitar para o registo de eventos e projetos com qualidade profissional.",
                "Promover a criatividade e a percepção estética.",
            ], 
            modules:[
                { title: "Módulo 1: Fundamentos e Equipamento", topics: ["Introdução à história e ao impacto da fotografia.", "Dominando o corpo da câmera: visor, obturador, diafragma e fotômetro.", "Entendendo ISO, lentes e o uso do flash.", "Controle de exposição e balanço de branco."] },
                { title: "Módulo 2: Composição e Iluminação", topics: ["A arte do enquadramento: planos, ângulos e lados.", "Trabalhando com a luz: compreendendo luz dura e luz suave.", "Princípios de composição de imagens: regra dos terços, formas e cores.", "Criando profundidade e perspectiva nas suas fotos."] },
                { title: "Módulo 3: Edição e Pós-Produção", topics: ["Introdução à edição e pós-produção no Lightroom.", "Análise do histograma e correção de cores.", "Definindo a intenção narrativa da sua fotografia.", "Exercícios práticos para aplicar todos os conceitos."] }
            ], 
            requirements:["Não são necessários pré-requisitos, apenas vontade de aprender.", "Incentivamos a trazer o seu próprio smartphone ou câmara."], 
            targetAudience:"O Curso de Fotografia é voltado para pessoas que desejam explorar o poder da imagem como forma de expressão, comunicação e transformação social. Destina-se a jovens, estudantes, profissionais da área criativa, comunicadores e entusiastas da fotografia, que buscam desenvolver um olhar técnico e artístico para capturar histórias, emoções e realidades por meio da lente.", 
            instructors: instructorsData.filter(i => ["bruno", "vinicius"].includes(i.id)).map(i => ({name: i.name, title: i.title, image: i.image})), // Pega dos dados acima
            details: { "Data": "28/10/2025", "Horário": "08:30-12:15", "Carga": "4h", "Certificado": "Sim", "Modalidade": "Presencial/Online" }, 
            practicalActivities:[
                { title: "Exercício de Teste: Contando uma História", description: "Em duplas, os participantes tiram 3 fotos um do outro para se acostumarem com os equipamentos e explorarem a narrativa visual." },
                { title: "Exercício de Conhecimento: Dominando a Luz", description: "Os participantes tiram 3-5 fotos com diferentes tipos de iluminação para entender na prática os conceitos de luz, sombra e intencionalidade." },
                { title: "Exercício Prático Transversal: A Evolução", description: "As duplas refazem as fotos do primeiro exercício, agora aplicando todos os conceitos aprendidos, para comparar e observar a sua evolução." }
            ]
          },
          { id: "ia", status: "aberto", themeColor: "#4CAF50", 
            title: "IA Aplicada à Análise de Dados", subtitle:"Do Relatório ao Insight", icon:"fa-brain", headerOverlayImage:"https://i.postimg.cc/bv25v2BZ/relat-rio-1.png", 
            summary:"Transforme relatórios e dados brutos em dashboards web interativos e de alto impacto. Capacite-se para tomar decisões estratégicas com mais clareza e agilidade.", 
            fullDescription:"Num mundo movido por dados, a capacidade de extrair insights rápidos é um superpoder. Com o 'Método Evereste Ágil', este curso vai desmistificar a IA e dar-lhe a autonomia para converter números complexos em apresentações dinâmicas e convincentes. Deixe de ser um espectador de relatórios e torne-se um protagonista na tomada de decisões estratégicas da nossa instituição.", 
            learningObjectives:[
                "Formular prompts eficazes no Gemini para gerar códigos de dashboards.",
                "Publicar um dashboard interativo na web utilizando o GitHub Pages.",
                "Estruturar uma apresentação de resultados de alto impacto.",
                "Adotar uma cultura de análise de dados ágil e orientada à ação.",
            ], 
            modules:[
                { title: "Módulo 1: Fundamentos e Geração de Código", topics: ["Os 3 pilares do Método Evereste Ágil.", "Introdução às ferramentas de inteligência artificial.", "O desafio da gestão moderna na análise de resultados.", "Oficina Prática: Construindo o prompt perfeito para o seu dashboard."] },
                { title: "Módulo 2: Publicação e Interatividade", topics: ["Desmistificando o GitHub: repositórios e o serviço GitHub Pages.", "Oficina Prática: Publicando o seu primeiro dashboard interativo na web.", "Análise e refinamento: como fazer pequenas alterações e atualizar o seu projeto."] },
                { title: "Módulo 3: Apresentação Estratégica e Encerramento", topics: ["Técnicas para apresentar resultados usando um dashboard dinâmico.", "Simulação de apresentação para a diretoria.", "Próximos passos para aplicar o método no dia a dia.", "Transformando a cultura de apresentação de resultados."] }
            ], 
            requirements:["É indispensável ter um notebook para participar nas atividades práticas.", "Computador com acesso à internet.", "Conta Google para acesso ao Gemini.", "Conta gratuita no ChatGPT.", "Conta no GitHub (pode ser criada durante o curso)."], 
            targetAudience:"Para todos os colaboradores, entusiastas de tecnologia e qualquer pessoa curiosa sobre o poder da inteligência artificial para simplificar tarefas. Não é necessário conhecimento prévio, apenas vontade de inovar.", 
            instructors: instructorsData.filter(i => ["marllon"].includes(i.id)).map(i => ({name: i.name, title: i.title, image: i.image})),
            details: { "Data": "06/11/2025", "Carga": "4h", "Certificado": "Sim", "Modalidade": "Presencial/Online", "Público": "Livre" }, 
            practicalActivities:[
                { title: "Oficina Prática 1: O Prompt Perfeito", description: "Os participantes recebem um relatório de exemplo e, com orientação, devem construir um prompt detalhado no Gemini para solicitar um dashboard." },
                { title: "Oficina Prática 2: O Seu Primeiro Dashboard no Ar", description: "Passo a passo guiado onde cada participante irá criar um repositório no GitHub, copiar o código do Gemini e publicar o seu dashboard online." },
                { title: "Simulação de Apresentação", description: "Voluntários apresentam o seu dashboard como se estivessem a falar para a diretoria, recebendo feedback construtivo." }
            ]
          },
          // Em Breve (Adicionados)
          { id: "conteudo", status: "em_breve", title: "Criação de Conteúdo Criativo", themeColor:"#6A4C93", icon:"fa-lightbulb", 
            instructors: instructorsData.filter(i => ["marllon", "vinicius", "keven"].includes(i.id)).map(i => ({name: i.name, title: i.title, image: i.image})),
            details: {}, learningObjectives: [], modules: [], requirements: [], practicalActivities: [] 
          },
          { id: "storytelling", status: "em_breve", title: "Storytelling e Copywriting", themeColor:"#FF6B35", icon:"fa-feather-alt", 
            instructors: instructorsData.filter(i => ["marllon", "vinicius"].includes(i.id)).map(i => ({name: i.name, title: i.title, image: i.image})),
            details: {}, learningObjectives: [], modules: [], requirements: [], practicalActivities: []
          },
          { id: "designthinking", status: "em_breve", title: "Design Thinking na Prática", themeColor:"#00A896", icon:"fa-drafting-compass", 
            instructors: instructorsData.filter(i => ["deyse"].includes(i.id)).map(i => ({name: i.name, title: i.title, image: i.image})),
            details: {}, learningObjectives: [], modules: [], requirements: [], practicalActivities: []
          },
          { id: "scrumkanban", status: "em_breve", title: "Scrum e Kanban para Equipes", themeColor:"#0066CC", icon:"fa-tasks", 
            instructors: instructorsData.filter(i => ["deyse"].includes(i.id)).map(i => ({name: i.name, title: i.title, image: i.image})),
            details: {}, learningObjectives: [], modules: [], requirements: [], practicalActivities: []
          }
      ];
      
      // Limpar campos JSON nulos ou indefinidos antes de salvar
      coursesData.forEach(course => {
          Object.keys(course).forEach(key => {
              if (course[key] === undefined || course[key] === null) {
                  delete course[key]; // Remove campos nulos/undefined
              }
              // Adiciona campos básicos se não existirem
              if (!course.details) course.details = {};
              if (!course.learningObjectives) course.learningObjectives = [];
              if (!course.modules) course.modules = [];
              if (!course.requirements) course.requirements = [];
              if (!course.practicalActivities) course.practicalActivities = [];
              if (!course.instructors) course.instructors = [];
          });
          const ref = doc(db, `artifacts/${appId}/public/data/courses`, course.id);
          batch.set(ref, course);
      });
      
      try {
        await batch.commit();
        showToast("Banco de dados populado com sucesso!", "success");
        // Recarregar tudo para refletir os novos dados
        loadCourses();
        loadInstructors();
        loadAdminCourses();
        loadAdminInstructors();
      } catch (error) {
        console.error("Erro ao popular banco de dados:", error);
        showToast(`Erro ao popular dados: ${error.message}`, "error");
      }
    });

  </script>
</body>
</html>
